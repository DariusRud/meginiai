<!DOCTYPE html>
<html lang="lt">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Mėginių Paėmimo Prototipas</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
			rel="stylesheet" />
		<style>
			body {
				font-family: 'Inter', sans-serif;
			}
			.step-card {
				transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
			}
			.hidden-step {
				display: none;
				opacity: 0;
				transform: scale(0.95);
			}
			.visible-step {
				display: block;
				opacity: 1;
				transform: scale(1);
			}
			.autocomplete-items div,
			.dropdown-items div {
				padding: 10px;
				cursor: pointer;
				background-color: #fff;
				border-bottom: 1px solid #ddd;
			}
			.autocomplete-items div:hover,
			.dropdown-items div:hover {
				background-color: #e9e9e9;
			}
			.autocomplete-active {
				background-color: DodgerBlue !important;
				color: #ffffff;
			}
		</style>
	</head>
	<body class="bg-gray-100 flex items-center justify-center min-h-screen">
		<div class="w-full max-w-5xl mx-auto p-4" id="main-process-container">
			<div class="px-4 sm:px-0">
				<div class="flex items-center justify-between mb-4">
					<div class="flex items-center">
						<svg
							xmlns="http://www.w3.org/2000/svg"
							width="32"
							height="32"
							viewBox="0 0 256 256"
							class="text-blue-600 mr-3">
							<path
								fill="currentColor"
								d="M216 72h-12.82A63.95 63.95 0 0 0 89.67 48.27L72.24 35.84A8 8 0 0 0 60.27 32H40a8 8 0 0 0 0 16h17.73l17.43 12.43A64.12 64.12 0 0 0 80 128a63.38 63.38 0 0 0 4.28 22.88a32 32 0 1 0 15.44 15.44A64 64 0 0 0 216 136V80a8 8 0 0 0-8-8M56 200a16 16 0 1 1 16 16a16 16 0 0 1-16-16m152-72h-72a56 56 0 0 1-52.2-35.34A56.24 56.24 0 0 1 136 80h72Z" />
						</svg>
						<h1 class="text-2xl font-bold text-gray-800">Mėginių Siuntimo Procesas</h1>
					</div>
					<div class="space-x-2">
						<button
							id="btn-open-register"
							class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
							Mėginių registras
						</button>
						<button
							id="btn-go-start"
							class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
							Į pradžią
						</button>
					</div>
				</div>
				<div class="relative w-full bg-gray-200 rounded-full h-2.5 mb-6">
					<div
						id="progressBar"
						class="bg-blue-600 h-2.5 rounded-full"
						style="width: 0%; transition: width 0.3s ease-in-out"></div>
				</div>
			</div>

			<div id="step-1" class="step-card bg-white p-8 rounded-xl shadow-lg visible-step">
				<h2 class="text-xl font-semibold text-gray-700 mb-1">1. Scenarijaus Pasirinkimas</h2>
				<p class="text-gray-500 mb-6">Pasirinkite mėginio siuntimo scenarijų.</p>
				<div id="scenarioOptions" class="space-y-3">
					<label
						class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-500 transition-all">
						<input
							type="radio"
							name="scenario"
							value="farm-vm"
							class="h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500" />
						<span class="ml-4 text-gray-800 font-medium">Ūkis -&gt; Viking Malt (VM)</span>
					</label>
					<label
						class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-500 transition-all">
						<input
							type="radio"
							name="scenario"
							value="farm-biliunai"
							class="h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500" />
						<span class="ml-4 text-gray-800 font-medium">Ūkis -&gt; BILIŪNAI Elevatorius</span>
					</label>
					<label
						class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-500 transition-all">
						<input
							type="radio"
							name="scenario"
							value="elevator-vm"
							class="h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500" />
						<span class="ml-4 text-gray-800 font-medium">Elevatorius -&gt; Viking Malt (VM)</span>
					</label>
					<label
						class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-500 transition-all">
						<input
							type="radio"
							name="scenario"
							value="elevator-biliunai"
							class="h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500" />
						<span class="ml-4 text-gray-800 font-medium"
							>Elevatorius -&gt; BILIŪNAI Elevatorius</span
						>
					</label>
					<label
						class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-500 transition-all">
						<input
							type="radio"
							name="scenario"
							value="elevator-office"
							class="h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500" />
						<span class="ml-4 text-gray-800 font-medium">Elevatorius -&gt; Ofisas</span>
					</label>
					<label
						class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-500 transition-all">
						<input
							type="radio"
							name="scenario"
							value="office-vm"
							class="h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500" />
						<span class="ml-4 text-gray-800 font-medium">Ofisas -&gt; Viking Malt (VM)</span>
					</label>
				</div>
				<div class="mt-4">
					<label for="auth-token" class="block text-sm font-medium text-gray-700"
						>Prieigos raktas</label
					>
					<input
						type="password"
						id="auth-token"
						class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
						placeholder="Įveskite raktą duomenų užklausai" />
					<p class="text-xs text-gray-500 mt-1">Raktas naudojamas vartotojo atpažinimui.</p>
				</div>
				<div class="mt-8 text-right">
					<button
						id="btn-step1-next"
						class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400 disabled:cursor-not-allowed"
						disabled>
						Toliau
					</button>
					<span id="step1-loading" class="hidden inline-flex items-center ml-3 text-blue-600">
						<svg
							class="animate-spin h-5 w-5 mr-2"
							xmlns="http://www.w3.org/2000/svg"
							fill="none"
							viewBox="0 0 24 24">
							<circle
								class="opacity-25"
								cx="12"
								cy="12"
								r="10"
								stroke="currentColor"
								stroke-width="4"></circle>
							<path
								class="opacity-75"
								fill="currentColor"
								d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
						</svg>
						Kraunama...
					</span>
				</div>
			</div>

			<div id="step-2" class="step-card bg-white p-8 rounded-xl shadow-lg hidden-step">
				<div class="mb-4">
					<span class="text-red-500 font-semibold">Scenarijus:</span>
					<span class="text-gray-700 font-medium ml-2 scenario-display-text"></span>
				</div>
				<h2 class="text-xl font-semibold text-gray-700 mb-1">2. Duomenų įvedimas</h2>
				<p class="text-gray-500 mb-6">
					Sudarykite siunčiamų mėginių sąrašą. Galima pridėti kelis mėginius iš skirtingų tiekėjų.
				</p>

				<!-- List of added samples -->
				<div class="flex justify-between items-center mb-2">
					<h3 class="text-lg font-medium text-gray-800">Pridėti mėginiai:</h3>
					<div id="shipping-from-info" class="hidden text-sm">
						<span class="font-medium text-gray-600">Siunčiama iš:</span>
						<span id="shipping-from-location" class="font-bold text-red-600 ml-1"></span>
					</div>
				</div>
				<div
					id="samples-list"
					class="space-y-2 mb-6 border p-4 rounded-lg bg-gray-50 min-h-[60px]">
					<p id="samples-list-placeholder" class="text-gray-500">Mėginių sąrašas tuščias.</p>
					<!-- JS will populate this -->
				</div>

				<!-- Form to add a new sample -->
				<div class="space-y-6 border border-gray-200 p-4 rounded-lg">
					<h3 class="text-lg font-medium text-gray-800">Įtraukti naują mėginį į siuntą</h3>
					<div id="elevator-container" class="hidden">
						<label for="elevator-select" class="block text-sm font-medium text-gray-700 mb-1"
							>Iš kur siunčiama (Elevatorius)</label
						>
						<select
							id="elevator-select"
							class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
						<div
							id="elevator-address"
							class="mt-2 text-sm text-gray-600 p-3 bg-gray-50 rounded-md border border-gray-200 hidden"></div>
					</div>

					<div class="relative">
						<label for="supplier" class="block text-sm font-medium text-gray-700 mb-1"
							>Iš kur siunčiama (Tiekėjas)</label
						>
						<input
							type="text"
							id="supplier"
							name="supplier"
							autocomplete="off"
							class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
							placeholder="Pradėkite vesti ūkio pavadinimą..." />
						<div
							id="autocomplete-list"
							class="absolute z-20 w-full bg-white border border-gray-300 rounded-b-md shadow-lg hidden autocomplete-items"></div>
						<div
							id="supplier-address"
							class="mt-2 text-sm text-gray-600 p-3 bg-gray-50 rounded-md border border-gray-200 hidden"></div>
					</div>

					<div id="annex-container" class="hidden">
						<label for="annex-search" class="block text-sm font-medium text-gray-700"
							>Priedo numeris</label
						>
						<div class="relative mt-1">
							<input
								type="text"
								id="annex-search"
								placeholder="Pasirinkite arba ieškokite..."
								autocomplete="off"
								class="w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
							<div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
								<svg
									class="h-5 w-5 text-gray-400"
									xmlns="http://www.w3.org/2000/svg"
									viewBox="0 0 20 20"
									fill="currentColor"
									aria-hidden="true">
									<path
										fill-rule="evenodd"
										d="M10 3a.75.75 0 01.53.22l3.5 3.5a.75.75 0 01-1.06 1.06L10 4.81 6.53 8.28a.75.75 0 01-1.06-1.06l3.5-3.5A.75.75 0 0110 3zm-3.72 9.28a.75.75 0 011.06 0L10 15.19l2.47-2.47a.75.75 0 111.06 1.06l-3.5 3.5a.75.75 0 01-1.06 0l-3.5-3.5a.75.75 0 010-1.06z"
										clip-rule="evenodd" />
								</svg>
							</div>
							<div
								id="annex-dropdown"
								class="absolute hidden z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto dropdown-items"></div>
						</div>
						<div
							id="annex-details"
							class="mt-2 text-sm text-gray-600 p-3 bg-gray-50 rounded-md border border-gray-200 hidden"></div>
					</div>
					<div id="sample-count-container" class="hidden">
						<label for="sample-count-input" class="block text-sm font-medium text-gray-700"
							>Mėginių skaičius</label
						>
						<input
							type="number"
							id="sample-count-input"
							value="1"
							min="1"
							class="mt-1 block w-full max-w-xs px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
					</div>
					<div class="mt-4 text-right">
						<button
							id="btn-add-sample"
							class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:bg-gray-400 disabled:cursor-not-allowed"
							disabled>
							+ Pridėti į sąrašą
						</button>
					</div>
				</div>
				<div class="mt-8 flex justify-between">
					<button
						class="btn-back bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
						Atgal
					</button>
					<button
						id="btn-step2-next"
						class="btn-next bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400"
						disabled>
						Toliau
					</button>
				</div>
			</div>

			<div id="step-3" class="step-card bg-white p-8 rounded-xl shadow-lg hidden-step">
				<div class="mb-4">
					<span class="text-red-500 font-semibold">Scenarijus:</span>
					<span class="text-gray-700 font-medium ml-2 scenario-display-text"></span>
				</div>
				<h2 class="text-xl font-semibold text-gray-700 mb-1">3. Lipdukai Mėginiams</h2>
				<p class="text-gray-500 mb-6">
					Patikrinkite sugeneruotus lipdukus ir nustatykite paėmimo datą.
				</p>

				<div class="mb-6">
					<div>
						<label for="step3-date" class="block text-sm font-medium text-gray-700 font-bold"
							>Paėmimo data:</label
						>
						<input
							type="date"
							id="step3-date"
							class="mt-1 block w-full max-w-xs px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
					</div>
				</div>

				<div id="sticker-list-container" class="space-y-8">
					<!-- JS will populate this with sticker previews -->
				</div>

				<div class="mt-8 flex justify-between">
					<button
						class="btn-back bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
						Atgal
					</button>
					<button
						class="btn-next bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">
						Toliau
					</button>
				</div>
			</div>

			<div id="step-4" class="step-card bg-white p-8 rounded-xl shadow-lg hidden-step">
				<div class="mb-4">
					<span class="text-red-500 font-semibold">Scenarijus:</span>
					<span class="text-gray-700 font-medium ml-2 scenario-display-text"></span>
				</div>
				<h2 class="text-xl font-semibold text-gray-700 mb-1">4. Siuntos Užsakymas</h2>
				<p class="text-gray-500 mb-6">Pasirinkite paėmimo datą ir sugeneruokite siuntos lipduką.</p>

				<div class="border-2 border-dashed rounded-lg p-4 bg-gray-50">
					<div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 mb-4 pb-4 border-b">
						<div>
							<h3 class="text-lg font-semibold text-blue-600">Mėginys bus paimtas iš:</h3>
							<div id="pickup-display-info" class="mt-2 text-gray-800 text-sm">
								<p class="font-bold" id="pickup-display-name"></p>
								<p id="pickup-display-address"></p>
							</div>
						</div>
						<div>
							<h3 class="text-lg font-semibold text-red-600">Kur pristatyti mėginį</h3>
							<div id="recipient-display-info" class="mt-2 text-gray-800 text-sm">
								<p class="font-bold" id="recipient-display-name"></p>
								<p id="recipient-display-address"></p>
								<p id="recipient-display-contact-person"></p>
								<p id="recipient-display-phone"></p>
							</div>
						</div>
					</div>

					<div class="mb-4 pb-4 border-b">
						<h3 class="text-lg font-semibold text-gray-700">Siunčiami mėginiai:</h3>
						<ul
							id="samples-summary-list"
							class="list-disc list-inside mt-2 text-sm text-gray-800 space-y-1">
							<!-- JS will populate this -->
						</ul>
					</div>

					<div class="text-center mb-4 border-b pb-4">
						<h4 class="text-md font-semibold text-red-600 mb-4">
							Informacija kurjeriui iš kur paimti mėginį
						</h4>
						<div class="mt-4 flex flex-col sm:flex-row items-center justify-center gap-4">
							<div>
								<label for="pickup-date" class="block text-sm font-medium text-gray-700 text-left"
									>Kada paimti:</label
								>
								<input
									type="date"
									id="pickup-date"
									class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
							</div>
							<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full sm:w-auto">
								<div>
									<label for="ship-city" class="block text-sm font-medium text-gray-700 text-left"
										>Miestas</label
									>
									<input
										id="ship-city"
										type="text"
										class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
								</div>
								<div>
									<label for="ship-street" class="block text-sm font-medium text-gray-700 text-left"
										>Gatvė</label
									>
									<input
										id="ship-street"
										type="text"
										class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
								</div>
								<div>
									<label
										for="ship-building"
										class="block text-sm font-medium text-gray-700 text-left"
										>Pastato nr.</label
									>
									<input
										id="ship-building"
										type="text"
										class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
								</div>
								<div>
									<label for="ship-postal" class="block text-sm font-medium text-gray-700 text-left"
										>Pašto kodas</label
									>
									<input
										id="ship-postal"
										type="text"
										class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
								</div>
								<div>
									<label for="ship-name" class="block text-sm font-medium text-gray-700 text-left"
										>Vardas</label
									>
									<input
										id="ship-name"
										type="text"
										class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
								</div>
								<div>
									<label for="ship-phone" class="block text-sm font-medium text-gray-700 text-left"
										>Telefono Nr.</label
									>
									<input
										id="ship-phone"
										type="text"
										class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
								</div>
								<div>
									<label for="ship-weight" class="block text-sm font-medium text-gray-700 text-left"
										>Siuntos svoris, kg</label
									>
									<input
										id="ship-weight"
										type="text"
										class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
								</div>
								<div>
									<label for="ship-parts" class="block text-sm font-medium text-gray-700 text-left"
										>Dalių skaičius, vnt.</label
									>
									<input
										id="ship-parts"
										type="text"
										class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
								</div>
							</div>
							<button
								id="generate-labels-btn"
								class="self-end sm:self-center bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 mt-2 sm:mt-0 whitespace-nowrap">
								Generuoti siuntos etiketę
							</button>
						</div>
						<div
							id="generation-success-msg"
							class="hidden mt-3 text-sm font-semibold text-green-600 flex items-center justify-center">
							<svg
								xmlns="http://www.w3.org/2000/svg"
								class="h-5 w-5 mr-2"
								viewBox="0 0 20 20"
								fill="currentColor">
								<path
									fill-rule="evenodd"
									d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
									clip-rule="evenodd" />
							</svg>
							<span>Etiketė sėkmingai sugeneruota!</span>
						</div>
					</div>

					<div id="omniva-sticker-preview" class="hidden">
						<h3 class="font-bold text-center text-gray-800 mb-2">Siuntos lipdukas</h3>
						<div class="bg-white p-4 rounded-md shadow-sm border text-gray-800">
							<div class="flex justify-between items-start pb-2 border-b">
								<div>
									<p class="text-xs mt-1">Siunta - Kurjeris</p>
								</div>
								<div class="text-right">
									<svg class="w-12 h-12" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
										<path
											fill="currentColor"
											d="M140 140h28v28h-28v-28Zm-56-56H56v28h28V84Zm0 56H56v28h28v-28Zm56-56h28v28h-28V84Zm56 0h28v28h-28V84Zm-56 56h28v28h-28v-28Zm56 0h28v28h-28v-28Zm-56 56h28v28h-28v-28Zm-28-28a12 12 0 1 1-12-12a12 12 0 0 1 12 12Zm112 0h28v28h-28v-28Zm-56 56h28v28h-28v-28Zm-56-56H56v28h28v-28Zm0-56H56v28h28V84Zm168 56h28v28h-28v-28ZM40 40a16 16 0 0 0-16 16v40H8a8 8 0 0 0 0 16h16v40H8a8 8 0 0 0 0 16h16v40a16 16 0 0 0 16 16h40v16a8 8 0 0 0 16 0v-16h40v16a8 8 0 0 0 16 0v-16h40v16a8 8 0 0 0 16 0v-16h40a16 16 0 0 0 16-16v-40h16a8 8 0 0 0 0-16h-16V96h16a8 8 0 0 0 0-16h-16V56a16 16 0 0 0-16-16H56A16 16 0 0 0 40 40Zm16 16h144v144H56V56Z" />
									</svg>
									<p class="text-sm font-mono mt-1" id="omniva-date"></p>
								</div>
							</div>
							<div class="grid grid-cols-6 gap-3 mt-3">
								<div
									class="col-span-1 text-xs font-bold transform -rotate-90 origin-center self-center text-center tracking-widest">
									SIUNTĖJAS
								</div>
								<div class="col-span-5 text-xs pl-2">
									<p class="font-bold">Baltijos Javai UAB</p>
									<p>Kauno m. Svirbygalos g. 19, LT-46280</p>
									<p>Kauno m. sav., Kauno apskr. Lietuva</p>
								</div>
							</div>
							<div class="grid grid-cols-6 gap-3 mt-3 pt-2 border-t">
								<div
									class="col-span-1 text-xs font-bold transform -rotate-90 origin-center self-center text-center tracking-widest">
									GAVĖJAS
								</div>
								<div class="col-span-5 text-xs pl-2">
									<p class="font-bold" id="recipient-name">UAB Viking Malt</p>
									<p id="recipient-contact">Dovydas</p>
									<p id="recipient-address-line1">
										Panevėžio m. Pramonės g. 2, LT-35289, Panevėžys
									</p>
									<p class="mt-1">
										<svg
											xmlns="http://www.w3.org/2000/svg"
											class="h-3 w-3 inline-block mr-1"
											viewBox="0 0 20 20"
											fill="currentColor">
											<path
												d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
										</svg>
										<span id="recipient-phone">+370 691 51153</span>
									</p>
								</div>
							</div>
							<div class="py-2 mt-2 border-y">
								<p class="text-xs font-semibold">Būtinai pasiskambinti prieš atvykstant</p>
							</div>
						</div>
					</div>
				</div>
				<div class="mt-8 flex justify-between">
					<button
						class="btn-back bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
						Atgal
					</button>
					<button
						class="btn-next bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
						Toliau
					</button>
				</div>
			</div>

			<div id="step-5" class="step-card bg-white p-8 rounded-xl shadow-lg hidden-step">
				<div class="mb-4">
					<span class="text-red-500 font-semibold">Scenarijus:</span>
					<span class="text-gray-700 font-medium ml-2 scenario-display-text"></span>
				</div>
				<h2 class="text-xl font-semibold text-gray-700 mb-1">5. El. laiško siuntimas</h2>
				<p class="text-gray-500 mb-6">
					Patikrinkite suformuotą el. laišką ūkiui ir prisegtus dokumentus.
				</p>
				<div class="border rounded-lg overflow-hidden bg-white shadow-sm">
					<div class="p-4 border-b bg-gray-50 space-y-2">
						<div>
							<label for="email-to-input" class="text-sm font-medium text-gray-500">Kam:</label>
							<input
								type="email"
								id="email-to-input"
								class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
						</div>
						<div>
							<label for="email-subject-input" class="text-sm font-medium text-gray-500"
								>Tema:</label
							>
							<input
								type="text"
								id="email-subject-input"
								class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
						</div>
					</div>
					<div class="p-4">
						<label for="email-body-input" class="text-sm font-medium text-gray-500"
							>Laiško tekstas:</label
						>
						<textarea
							id="email-body-input"
							rows="10"
							class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
						<div class="mt-2 text-sm text-red-600">
							Svarbu: jeigu mėginys bus be lipduko, kuris yra sukurtas jus identifikuoti, tyrimas
							laboratorijoje nebus atliekamas.
						</div>
					</div>

					<div class="p-4 border-t bg-gray-50">
						<h4 class="text-sm font-semibold mb-2 text-gray-600">Prisegtukai (2):</h4>
						<div
							id="attachments-cooldown-msg"
							class="hidden text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded px-2 py-1 mb-2">
							Failai ruošiami. Galėsite atsisiųsti po
							<span id="attachments-cooldown-seconds">10</span> s.
						</div>
						<div class="flex space-x-3">
							<button
								id="download-sample-sticker"
								class="flex items-center bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full hover:bg-blue-200 cursor-pointer">
								<svg
									class="w-4 h-4 mr-1.5"
									fill="none"
									stroke="currentColor"
									viewBox="0 0 24 24"
									xmlns="http://www.w3.org/2000/svg">
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
								</svg>
								meginio_lipdukas.pdf
							</button>
							<button
								id="download-post-sticker"
								class="flex items-center bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full hover:bg-blue-200 cursor-pointer">
								<svg
									class="w-4 h-4 mr-1.5"
									fill="none"
									stroke="currentColor"
									viewBox="0 0 24 24"
									xmlns="http://www.w3.org/2000/svg">
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
								</svg>
								siuntos_lipdukas.pdf
							</button>
						</div>
					</div>
				</div>
				<div class="mt-8 flex justify-between">
					<button
						class="btn-back bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
						Atgal
					</button>
					<div class="flex items-center">
						<button
							class="btn-next bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
							Siųsti
						</button>
						<span id="step5-sending" class="hidden inline-flex items-center ml-3 text-green-600">
							<svg
								class="animate-spin h-5 w-5 mr-2"
								xmlns="http://www.w3.org/2000/svg"
								fill="none"
								viewBox="0 0 24 24">
								<circle
									class="opacity-25"
									cx="12"
									cy="12"
									r="10"
									stroke="currentColor"
									stroke-width="4"></circle>
								<path
									class="opacity-75"
									fill="currentColor"
									d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
							</svg>
							Siunčiama...
						</span>
					</div>
				</div>
			</div>

			<div id="step-6" class="step-card bg-white p-8 rounded-xl shadow-lg hidden-step">
				<div class="text-center">
					<div class="mb-4">
						<span class="text-red-500 font-semibold">Scenarijus:</span>
						<span class="text-gray-700 font-medium ml-2 scenario-display-text"></span>
					</div>
					<div
						class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
						<svg
							class="h-10 w-10 text-green-600"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
							xmlns="http://www.w3.org/2000/svg">
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M5 13l4 4L19 7"></path>
						</svg>
					</div>
					<h2 class="text-2xl font-bold text-gray-800">Sėkmingai išsiųsta!</h2>
					<p class="text-gray-500 mt-2 mb-6">
						Laiškas ir dokumentai buvo sėkmingai išsiųsti tiekėjui.
					</p>
				</div>
				<div class="mt-8 flex items-center justify-center space-x-4">
					<button
						id="btn-open-register-success"
						class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700">
						Mėginių registras
					</button>
					<button
						id="btn-restart"
						class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">
						Pradėti iš naujo
					</button>
				</div>
			</div>
		</div>

		<div id="register-view" class="w-full max-w-7xl mx-auto p-2 hidden">
			<div class="bg-white p-6 rounded-xl shadow-lg">
				<h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
					Išsiųstų Mėginių Registras
				</h2>
				<div class="mb-4">
					<label for="register-annex-filter" class="block text-sm font-medium text-gray-700 mb-1"
						>Filtruoti pagal "Tiekėjas"</label
					>
					<input
						id="register-annex-filter"
						type="text"
						placeholder="Įveskite tiekėjo pavadinimą..."
						class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
				</div>
				<div
					class="overflow-x-auto overflow-y-auto border rounded-lg"
					style="max-height: 70vh; -webkit-overflow-scrolling: touch; overscroll-behavior: contain">
					<table class="min-w-full divide-y divide-gray-200 text-sm">
						<thead class="bg-gray-50 sticky top-0 z-10">
							<tr>
								<th
									class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
									Vadybininkas
								</th>
								<th
									class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
									Užpildymo data
								</th>
								<th
									class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
									Rezultatas gautas
								</th>
								<th
									id="th-paemimo-data"
									class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer select-none">
									Paėmimo Data
									<span class="inline-block text-gray-400" id="sort-ind-paemimo">↕</span>
								</th>
								<th
									id="th-meginio-nr"
									class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer select-none">
									Mėginio Nr.
									<span class="inline-block text-gray-400" id="sort-ind-meginio">↕</span>
								</th>
								<th
									class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
									Tiekėjas
								</th>
								<th
									class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
									Paėmimo Vieta
								</th>
								<th
									class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
									Siunčiama į
								</th>
								<th
									class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
									Sutarties Priedas
								</th>
								<th
									class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
									Veislė
								</th>
								<th
									id="th-busena"
									class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer select-none">
									Būsena
									<span class="inline-block text-gray-400" id="sort-ind-busena">↕</span>
								</th>
							</tr>
						</thead>
						<tbody id="register-table-body" class="bg-white divide-y divide-gray-200"></tbody>
					</table>
				</div>
				<div class="mt-8 text-center">
					<button
						id="btn-back-to-main"
						class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">
						Atgal į procesą
					</button>
				</div>
			</div>
		</div>

		<div
			id="custom-modal"
			class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
			<div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-xl bg-white">
				<div class="mt-3 text-center">
					<div
						class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
						<svg
							class="h-6 w-6 text-blue-600"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
							xmlns="http://www.w3.org/2000/svg">
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
						</svg>
					</div>
					<h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Pranešimas</h3>
					<div class="mt-2 px-7 py-3">
						<p class="text-sm text-gray-500" id="modal-message"></p>
					</div>
					<div class="items-center px-4 py-3" id="modal-buttons"></div>
				</div>
			</div>
		</div>

		<script>
			document.addEventListener('DOMContentLoaded', function () {
				const modal = document.getElementById('custom-modal');
				const modalTitle = document.getElementById('modal-title');
				const modalMessage = document.getElementById('modal-message');
				const modalButtons = document.getElementById('modal-buttons');

				function hideModal() {
					modal.classList.add('hidden');
				}

				function showModal(title, message, buttons) {
					modalTitle.textContent = title;
					modalMessage.textContent = message;
					modalButtons.innerHTML = '';
					const buttonContainer = document.createElement('div');
					buttonContainer.className = 'flex justify-center space-x-4';

					buttons.forEach(btnConfig => {
						const button = document.createElement('button');
						button.textContent = btnConfig.text;
						button.className = btnConfig.classes;
						button.addEventListener('click', () => {
							hideModal();
							if (btnConfig.onClick) {
								btnConfig.onClick();
							}
						});
						buttonContainer.appendChild(button);
					});

					modalButtons.appendChild(buttonContainer);
					modal.classList.remove('hidden');
				}

				function customAlert(message, title = 'Pranešimas') {
					showModal(title, message, [
						{
							text: 'Gerai',
							classes:
								'px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-lg w-24 shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500',
							onClick: () => {},
						},
					]);
				}

				function customConfirm(message, callback, title = 'Patvirtinimas') {
					showModal(title, message, [
						{
							text: 'Atšaukti',
							classes:
								'px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-lg w-24 shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400',
							onClick: () => callback(false),
						},
						{
							text: 'Gerai',
							classes:
								'px-4 py-2 bg-green-600 text-white text-base font-medium rounded-lg w-24 shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500',
							onClick: () => callback(true),
						},
					]);
				}

				let currentStep = 1;
				const totalSteps = 6;
				let sampleCounter = 230;
				let selectedSamples = []; // <-- Array to hold multiple samples
				let selectedScenario = null;
				let selectedScenarioText = '';

				let suppliers = [];
				const SUPPLIERS_ENDPOINT =
					'https://operations.baltijosjavai.lt/webhook/get-clients-with-data';
				const UPDATE_ENDPOINT = 'https://operations.baltijosjavai.lt/webhook/update-sample';
				const GET_SAMPLES_ENDPOINT =
					'https://operations.baltijosjavai.lt/webhook/get-samples-history';
				const ELEVATORS_ENDPOINT = 'https://operations.baltijosjavai.lt/webhook/elevators';

				const loadSuppliers = async token => {
					try {
						const url = new URL(SUPPLIERS_ENDPOINT);
						if (selectedScenario) url.searchParams.set('scenario', selectedScenario);
						const resp = await fetch(url.toString(), {
							headers: { accept: 'application/json', Authorization: token || '' },
						});
						if (!resp.ok) {
							let bodyText = '';
							try {
								bodyText = await resp.text();
							} catch {}
							throw new Error(
								`Suppliers fetch failed: HTTP ${resp.status}${bodyText ? ' - ' + bodyText : ''}`
							);
						}
						const data = await resp.json();

						const candidates = Array.isArray(data)
							? data
							: Array.isArray(data?.suppliers)
							? data.suppliers
							: Array.isArray(data?.data)
							? data.data
							: null;
						if (!Array.isArray(candidates)) throw new Error('Neteisingas duomenų formatas');

						suppliers = candidates.map(s => ({
							...s,
							Id: s.Id ?? s.id ?? s.ID ?? null,
							name: s.name ?? s.pavadinimas ?? s.title ?? '',
							priedai: s.priedai ?? s.annexes ?? s.attachments ?? [],
						}));
					} catch (err) {
						console.error('Nepavyko užkrauti tiekėjų sąrašo iš webhook:', err);
						throw err;
					}
				};

				let tempSelectedSupplier = null; // Temporary holder for the add form
				let tempSelectedAnnex = null; // Temporary holder for the add form
				let authToken = '';

				function tokenHasInvalidChars(value) {
					if (!value) return false;
					for (const ch of value) {
						const cp = ch.codePointAt(0);
						if (cp > 255) return true;
					}
					return false;
				}

				let elevators = [];
				let selectedElevator = null;
				async function loadElevators(token) {
					const headers = { accept: 'application/json' };
					if (token) headers['Authorization'] = token;
					const url = new URL(ELEVATORS_ENDPOINT);
					if (selectedScenario) url.searchParams.set('scenario', selectedScenario);
					const resp = await fetch(url.toString(), { headers });
					if (!resp.ok) throw new Error('HTTP ' + resp.status);
					const data = await resp.json();

					let list = null;
					if (Array.isArray(data) && data.length && Array.isArray(data[0]?.elevators)) {
						list = data[0].elevators;
					} else if (data && Array.isArray(data.elevators)) {
						list = data.elevators;
					} else if (Array.isArray(data)) {
						list = data;
					}
					if (!Array.isArray(list)) throw new Error('Neteisingas elevatorių formatas');
					elevators = list.map(e => ({
						...e,
						Id: e.Id ?? e.id ?? e.ID ?? null,
						pavadinimas: e.pavadinimas ?? e.name ?? '',
						kodas: e.kodas ?? e.code ?? '',
					}));
				}

				const steps = document.querySelectorAll('.step-card');
				const progressBar = document.getElementById('progressBar');
				const nextButtons = document.querySelectorAll('.btn-next');
				const backButtons = document.querySelectorAll('.btn-back');
				const step1NextBtn = document.getElementById('btn-step1-next');
				const step1Loading = document.getElementById('step1-loading');
				const tokenInput = document.getElementById('auth-token');
				const step2NextBtn = document.getElementById('btn-step2-next');
				const scenarioRadios = document.querySelectorAll('input[name="scenario"]');
				const supplierInput = document.getElementById('supplier');
				const supplierAddressDiv = document.getElementById('supplier-address');
				const supplierLabel = document.querySelector('label[for="supplier"]');
				const autocompleteList = document.getElementById('autocomplete-list');
				const annexContainer = document.getElementById('annex-container');
				const annexSearchInput = document.getElementById('annex-search');
				const annexDropdown = document.getElementById('annex-dropdown');
				const annexDetailsDiv = document.getElementById('annex-details');
				const pickupDateInput = document.getElementById('pickup-date');
				const generateLabelsBtn = document.getElementById('generate-labels-btn');
				const omnivaStickerPreview = document.getElementById('omniva-sticker-preview');
				const generationSuccessMsg = document.getElementById('generation-success-msg');
				const step4NextBtn = document.querySelector('#step-4 .btn-next');
				const step5SendBtn = document.querySelector('#step-5 .btn-next');
				let omnivaGenerated = false;
				let generationMsgTimeout = null;
				let attachmentsReadyAt = 0;
				let attachmentsCooldownTimer = null;

				// New elements for multiple samples
				const btnAddSample = document.getElementById('btn-add-sample');
				const samplesList = document.getElementById('samples-list');
				const samplesListPlaceholder = document.getElementById('samples-list-placeholder');
				const shippingFromInfo = document.getElementById('shipping-from-info');
				const shippingFromLocation = document.getElementById('shipping-from-location');
				const stickerListContainer = document.getElementById('sticker-list-container');
				const samplesSummaryList = document.getElementById('samples-summary-list');
				const sampleCountContainer = document.getElementById('sample-count-container');
				const sampleCountInput = document.getElementById('sample-count-input');

				const mainProcessContainer = document.getElementById('main-process-container');
				const registerView = document.getElementById('register-view');
				const openRegisterBtn = document.getElementById('btn-open-register');
				const backToMainBtn = document.getElementById('btn-back-to-main');
				const openRegisterSuccessBtn = document.getElementById('btn-open-register-success');
				const goStartBtn = document.getElementById('btn-go-start');

				const registerAnnexFilterInput = document.getElementById('register-annex-filter');
				const thPaemimo = document.getElementById('th-paemimo-data');
				const thMeginio = document.getElementById('th-meginio-nr');
				const thBusena = document.getElementById('th-busena');
				const sortIndPaemimo = document.getElementById('sort-ind-paemimo');
				const sortIndMeginio = document.getElementById('sort-ind-meginio');

				let registerRowsOriginal = [];
				let registerSortKey = null;
				let registerSortDir = 'asc';
				let registerAnnexFilter = '';

				function parseDateSafe(value) {
					if (!value) return NaN;
					const t = Date.parse(value);
					return isNaN(t) ? NaN : t;
				}

				function formatDateYYYYMMDD(value) {
					if (!value) return 'N/A';
					const s = value.toString();
					const datePart = s.includes('T') ? s.split('T')[0] : s.split(' ')[0];
					return datePart || s;
				}

				function compareValues(a, b, key) {
					const va = a && a[key];
					const vb = b && b[key];
					if (key === 'paemimo_data') {
						const da = parseDateSafe(va);
						const db = parseDateSafe(vb);
						if (!isNaN(da) && !isNaN(db)) return da - db;
					}
					if (key === 'busena') {
						const order = { Išsiųsta: 0, Atsakyta: 1 };
						const sa = (a && a._busenaText) || (order[va] !== undefined ? va : '');
						const sb = (b && b._busenaText) || (order[vb] !== undefined ? vb : '');
						const oa = order[sa] !== undefined ? order[sa] : 0;
						const ob = order[sb] !== undefined ? order[sb] : 0;
						if (oa !== ob) return oa - ob;
					}
					const sa = (va ?? '').toString().toLowerCase();
					const sb = (vb ?? '').toString().toLowerCase();
					if (sa < sb) return -1;
					if (sa > sb) return 1;
					return 0;
				}

				function setSortIndicators() {
					if (sortIndPaemimo)
						sortIndPaemimo.textContent =
							registerSortKey === 'paemimo_data' ? (registerSortDir === 'asc' ? '↑' : '↓') : '↕';
					if (sortIndMeginio)
						sortIndMeginio.textContent =
							registerSortKey === 'kodas' ? (registerSortDir === 'asc' ? '↑' : '↓') : '↕';
					const sortIndBusena = document.getElementById('sort-ind-busena');
					if (sortIndBusena)
						sortIndBusena.textContent =
							registerSortKey === 'busena' ? (registerSortDir === 'asc' ? '↑' : '↓') : '↕';
				}

				function renderRegisterTable(tbodyElement) {
					if (!tbodyElement) return;
					let rows = Array.isArray(registerRowsOriginal) ? [...registerRowsOriginal] : [];

					if (registerAnnexFilter) {
						const q = registerAnnexFilter.toLowerCase();
						rows = rows.filter(r =>
							((r && r.klientas && r.klientas.pavadinimas) || '').toLowerCase().includes(q)
						);
					}

					if (registerSortKey) {
						rows.sort((a, b) => compareValues(a, b, registerSortKey));
						if (registerSortDir === 'desc') rows.reverse();
					}

					tbodyElement.innerHTML = '';
					if (rows.length === 0) {
						tbodyElement.innerHTML =
							'<tr><td colspan="11" class="text-center p-4">Duomenų nerasta.</td></tr>';
						return;
					}

					rows.forEach(r => {
						const vadybininkas = (r && r.vadybininkas) || 'N/A';
						const uzpildymo_raw = (r && (r.CreatedAt || r.createdAt || r.created_at)) || '';
						const uzpildymo_data = formatDateYYYYMMDD(uzpildymo_raw) || 'N/A';
						const yraAtsakymas = !!(r && r.atsakymas);
						const busenaText = yraAtsakymas ? 'Atsakyta' : 'Išsiųsta';
						const busenaClass = yraAtsakymas
							? 'bg-blue-100 text-blue-800'
							: 'bg-green-100 text-green-800';
						const rezultatas_gautas = (r && r.atsakymo_data) || '';
						const paemimo_data = (r && r.paemimo_data) || 'N/A';
						const kodas = (r && r.kodas) || 'N/A';
						const tiekejas = (r && r.klientas && r.klientas.pavadinimas) || 'N/A';
						const paemimo_vieta = (r && r.sandelys) || 'N/A';
						const siunciama_i = (r && r.pristatymo_vieta) || 'N/A';
						const sutarties_priedas = (r && r.priedo_pavadinimas) || 'N/A';
						const veisle = (r && (r.veisle || r.variety)) || '';
						const tr = document.createElement('tr');
						tr.innerHTML = `
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${vadybininkas}</td>
								<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${uzpildymo_data}</td>
								<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${rezultatas_gautas || '–'}</td>
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${paemimo_data}</td>
							<td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">${kodas}</td>
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${tiekejas}</td>
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${paemimo_vieta}</td>
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${siunciama_i}</td>
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${sutarties_priedas}</td>
								<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${veisle || '–'}</td>
								<td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${busenaClass}">${busenaText}</span></td>
						`;
						tbodyElement.appendChild(tr);
						r._busena = yraAtsakymas ? 1 : 0;
						r._busenaText = busenaText;
					});

					setSortIndicators();
				}

				const elevatorContainer = document.getElementById('elevator-container');
				const elevatorSelect = document.getElementById('elevator-select');
				const elevatorAddressDiv = document.getElementById('elevator-address');

				function populateElevatorDropdown() {
					elevatorSelect.innerHTML =
						'<option value="" disabled selected>Pasirinkite elevatorių...</option>';
					(elevators || []).forEach(elevator => {
						const option = document.createElement('option');
						option.value = elevator.Id;
						const code = elevator.kodas || '';
						option.textContent = `${code ? code + ' - ' : ''}${elevator.pavadinimas || ''}`;
						elevatorSelect.appendChild(option);
					});
				}
				populateElevatorDropdown();

				function showGenerationSuccessOnce() {
					if (generationMsgTimeout) {
						clearTimeout(generationMsgTimeout);
						generationMsgTimeout = null;
					}
					generationSuccessMsg.classList.remove('hidden');
					generationMsgTimeout = setTimeout(() => {
						generationSuccessMsg.classList.add('hidden');
						generationMsgTimeout = null;
					}, 3000);
				}

				function setAttachmentButtonsEnabled(enabled) {
					const sampleBtn = document.getElementById('download-sample-sticker');
					const postBtn = document.getElementById('download-post-sticker');
					[sampleBtn, postBtn].forEach(btn => {
						if (!btn) return;
						btn.disabled = !enabled;
						if (enabled) {
							btn.classList.remove('opacity-50', 'cursor-not-allowed');
							btn.classList.add('cursor-pointer');
						} else {
							btn.classList.add('opacity-50', 'cursor-not-allowed');
							btn.classList.remove('cursor-pointer');
						}
					});
				}

				function startAttachmentsCooldown(seconds = 10) {
					const msg = document.getElementById('attachments-cooldown-msg');
					const secs = document.getElementById('attachments-cooldown-seconds');
					attachmentsReadyAt = Date.now() + seconds * 1000;
					if (msg) msg.classList.remove('hidden');
					setAttachmentButtonsEnabled(false);
					if (step5SendBtn) step5SendBtn.disabled = true;
					if (step5SendBtn) {
						step5SendBtn.classList.add('disabled:cursor-not-allowed');
					}
					if (secs) secs.textContent = String(seconds);
					if (attachmentsCooldownTimer) {
						clearInterval(attachmentsCooldownTimer);
						attachmentsCooldownTimer = null;
					}
					attachmentsCooldownTimer = setInterval(() => {
						const remainMs = attachmentsReadyAt - Date.now();
						const remain = Math.max(0, Math.ceil(remainMs / 1000));
						if (secs) secs.textContent = String(remain);
						if (remain <= 0) {
							clearInterval(attachmentsCooldownTimer);
							attachmentsCooldownTimer = null;
							if (msg) msg.classList.add('hidden');
							setAttachmentButtonsEnabled(true);
							if (step5SendBtn && omnivaGenerated) step5SendBtn.disabled = false;
							if (step5SendBtn) step5SendBtn.classList.remove('disabled:cursor-not-allowed');
						}
					}, 200);
				}

				function attachmentsAvailable() {
					return Date.now() >= attachmentsReadyAt;
				}

				async function downloadWithAuth(url, filename) {
					try {
						const headers = { accept: 'application/pdf', 'content-type': 'application/json' };
						if (authToken) headers['Authorization'] = authToken;
						const clientIds = [
							...new Set(selectedSamples.map(s => s.supplier?.Id ?? s.supplier?.id).filter(Boolean)),
						];
						if (clientIds.length === 0) {
							customAlert('Nepasirinktas joks klientas – negalima atsisiųsti failo.');
							return;
						}
						if (!attachmentsAvailable()) {
							const remain = Math.max(0, Math.ceil((attachmentsReadyAt - Date.now()) / 1000));
							customAlert('Failai dar ruošiami. Bandykite po ' + remain + ' s.');
							return;
						}
						const resp = await fetch(url, {
							method: 'POST',
							headers,
							body: JSON.stringify({ clientIds, scenario: selectedScenario || null }),
						});
						if (!resp.ok) throw new Error('HTTP ' + resp.status);
						const blob = await resp.blob();
						const a = document.createElement('a');
						const objectUrl = URL.createObjectURL(blob);
						a.href = objectUrl;
						a.download = filename;
						document.body.appendChild(a);
						a.click();
						a.remove();
						URL.revokeObjectURL(objectUrl);
					} catch (e) {
						console.error('Download failed:', e);
						customAlert('Nepavyko atsisiųsti failo. Patikrinkite ryšį ir bandykite dar kartą.');
					}
				}
				const sampleStickerBtn = document.getElementById('download-sample-sticker');
				if (sampleStickerBtn) {
					sampleStickerBtn.addEventListener('click', () => {
						downloadWithAuth(
							'https://operations.baltijosjavai.lt/webhook/download-sample-sticker',
							'meginio_lipdukas.pdf'
						);
					});
				}
				const postStickerBtn = document.getElementById('download-post-sticker');
				if (postStickerBtn) {
					postStickerBtn.addEventListener('click', () => {
						downloadWithAuth(
							'https://operations.baltijosjavai.lt/webhook/download-post-sticker',
							'siuntos_lipdukas.pdf'
						);
					});
				}

				const updateProgressBar = () => {
					const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
					progressBar.style.width = `${progress}%`;
				};

				function updatePickupDetails(scenario) {
					const pickup = { name: '', address: '' };
					const nameEl = document.getElementById('pickup-display-name');
					const addressEl = document.getElementById('pickup-display-address');

					if (!nameEl || !addressEl) return;

					if (scenario === 'farm-vm' || scenario === 'farm-biliunai') {
						if (selectedSamples.length > 0 && selectedSamples[0].supplier) {
							const firstSupplier = selectedSamples[0].supplier;
							pickup.name = firstSupplier.name || 'Nenurodytas ūkis';
							let addr = '';
							if (firstSupplier.address && typeof firstSupplier.address === 'object') {
								const a = firstSupplier.address;
								const parts = [
									a.street,
									a.building || a.building_number,
									a.city,
									a.postal_code,
								].filter(Boolean);
								addr = parts.join(', ');
							}
							pickup.address = addr;
						}
					} else if (scenario.startsWith('elevator-')) {
						if (selectedElevator) {
							pickup.name = selectedElevator.pavadinimas || 'Nenurodytas elevatorius';
							let addr = '';
							const parts = [
								selectedElevator.gatve,
								selectedElevator.pastato_nr,
								selectedElevator.miestas,
								selectedElevator.pasto_kodas,
							].filter(Boolean);
							addr = parts.join(', ');
							pickup.address = addr;
						}
					} else if (scenario === 'office-vm') {
						pickup.name = 'UAB "Baltijos javai" (Ofisas)';
						pickup.address = 'Svirbygalos g. 19, Kaunas, LT-46280';
					}

					nameEl.textContent = pickup.name;
					addressEl.innerHTML = `<span class="font-semibold text-red-600">Adresas:</span> ${
						pickup.address || ''
					}`;
				}

				function updateRecipientDetails(scenario) {
					const recipient = { name: '', contact: '', address: '', phone: '' };

					switch (scenario) {
						case 'farm-vm':
						case 'elevator-vm':
						case 'office-vm':
							recipient.name = 'UAB Viking Malt';
							recipient.contact = 'Dovydas';
							recipient.address = 'Panevėžio m. Pramonės g. 2, LT-35289, Panevėžys';
							recipient.phone = '+370 691 51153';
							break;
						case 'elevator-biliunai':
						case 'farm-biliunai':
							recipient.name = 'UAB "Biliūnų grūdai"';
							recipient.contact = 'Priėmimo skyrius';
							recipient.address = 'Biliūnai, Raseinių r. sav., LT-60200';
							recipient.phone = '+370 612 34567';
							break;
						case 'elevator-office':
							recipient.name = 'UAB "Baltijos javai" (Ofisas)';
							recipient.contact = 'Renata Bernotienė';
							recipient.address = 'Svirbygalos g. 19, Kaunas, LT-46280';
							recipient.phone = '+370 699 99999';
							break;
					}

					const stickerNameEl = document.getElementById('recipient-name');
					const stickerContactEl = document.getElementById('recipient-contact');
					const stickerAddressEl = document.getElementById('recipient-address-line1');
					const stickerPhoneEl = document.getElementById('recipient-phone');

					if (stickerNameEl) stickerNameEl.textContent = recipient.name;
					if (stickerContactEl) stickerContactEl.textContent = recipient.contact;
					if (stickerAddressEl) stickerAddressEl.textContent = recipient.address;
					if (stickerPhoneEl) stickerPhoneEl.textContent = recipient.phone;

					const displayNameEl = document.getElementById('recipient-display-name');
					const displayAddressEl = document.getElementById('recipient-display-address');
					const displayContactPersonEl = document.getElementById(
						'recipient-display-contact-person'
					);
					const displayPhoneEl = document.getElementById('recipient-display-phone');

					if (displayNameEl) displayNameEl.textContent = recipient.name;
					if (displayAddressEl) displayAddressEl.textContent = `Adresas: ${recipient.address}`;
					if (displayContactPersonEl)
						displayContactPersonEl.textContent = `Kontaktinis asmuo: ${recipient.contact}`;
					if (displayPhoneEl) displayPhoneEl.textContent = `Tel.: ${recipient.phone}`;
				}

				const showStep = stepNumber => {
					steps.forEach((step, index) => {
						step.classList.toggle('visible-step', index + 1 === stepNumber);
						step.classList.toggle('hidden-step', index + 1 !== stepNumber);
					});

					if (stepNumber === 1) {
						omnivaGenerated = false;
					}

					if (stepNumber === 3) {
						stickerListContainer.innerHTML = '';
						const dateValue = document.getElementById('step3-date').value;
						const dateText = dateValue
							? new Date(dateValue).toLocaleDateString('lt-LT')
							: new Date().toLocaleDateString('lt-LT');

						selectedSamples.forEach(sample => {
							let groupIndicator = '';
							if (sample.groupTotal > 1) {
								groupIndicator = ` (${sample.groupIndex}/${sample.groupTotal})`;
							}
							const quantityValue = sample.annex.quantity || 'N/A';
							const stickerHTML = `
                        <div class="border-2 border-dashed rounded-lg p-4 bg-gray-50">
                            <h3 class="font-bold text-center text-gray-800 mb-2">Mėginio lipdukas (${
															sample.supplier.name
														})${groupIndicator}</h3>
                            <div class="grid grid-cols-2 gap-0 border bg-white shadow-sm p-2">
                                <div class="p-2 border-r">
                                    <div class="text-left mb-2 pb-2">
                                        <p class="font-bold text-sm">BALTIJOS JAVAI</p>
                                        <p class="text-xs text-gray-600">Tiekėjas: ${
																					sample.supplier.name
																				}</p>
                                    </div>
                                    <div class="space-y-1 text-xs">
                                        <p><span class="font-semibold">Paėmimo data:</span> <span>${dateText}</span></p>
                                        <p><span class="font-semibold">Veislė:</span> <span>${
																					sample.annex.veisle || sample.annex.variety || ''
																				}</span></p>
                                        <p><span class="font-semibold">Kiekis:</span> <span>${quantityValue}</span></p>
                                    </div>
                                    <div class="mt-2 h-16 border-t border-gray-200"></div>
                                </div>

                                <div class="p-2">
                                   <div class="text-left mb-2 pb-2">
                                        <p class="font-bold text-sm">BALTIJOS JAVAI</p>
                                        <p class="text-xs text-gray-600">Tiekėjas: ${
																					sample.supplier.name
																				}</p>
                                    </div>
                                    <div class="space-y-1 text-xs">
                                        <p><span class="font-semibold">Paėmimo data:</span> <span>${dateText}</span></p>
                                        <p><span class="font-semibold">Veislė:</span> <span>${
																					sample.annex.veisle || sample.annex.variety || ''
																				}</span></p>
                                        <p><span class="font-semibold">Kiekis:</span> <span>${quantityValue}</span></p>
                                    </div>
                                    <div class="mt-2 h-16 border-t border-gray-200"></div>
                                </div>
                            </div>
                        </div>`;
							stickerListContainer.insertAdjacentHTML('beforeend', stickerHTML);
						});
					}

					if (stepNumber === 4) {
						omnivaStickerPreview.classList.add('hidden');
						generationSuccessMsg.classList.add('hidden');

						updateRecipientDetails(selectedScenario);
						updatePickupDetails(selectedScenario);

						samplesSummaryList.innerHTML = '';
						selectedSamples.forEach(sample => {
							const li = document.createElement('li');
							let groupText = '';
							if (sample.groupTotal > 1) {
								groupText = ` (${sample.groupIndex}/${sample.groupTotal})`;
							}
							li.textContent = `Tiekėjas: ${sample.supplier.name}, Priedas: ${sample.annex.nr}${groupText}`;
							samplesSummaryList.appendChild(li);
						});

						if (!pickupDateInput.value) {
							const step3DateEl = document.getElementById('step3-date');
							if (step3DateEl && step3DateEl.value) {
								pickupDateInput.value = step3DateEl.value;
							}
						}

						const omnivaDateEl = document.getElementById('omniva-date');
						if (omnivaDateEl && pickupDateInput.value) {
							omnivaDateEl.textContent = pickupDateInput.value;
						}

						const cityEl = document.getElementById('ship-city');
						const streetEl = document.getElementById('ship-street');
						const buildingEl = document.getElementById('ship-building');
						const postalEl = document.getElementById('ship-postal');

						cityEl.value = '';
						streetEl.value = '';
						buildingEl.value = '';
						postalEl.value = '';

						const isElevatorScenario = selectedScenario.startsWith('elevator-');
						if (isElevatorScenario && selectedElevator) {
							if (cityEl) cityEl.value = selectedElevator.miestas || '';
							if (streetEl) streetEl.value = selectedElevator.gatve || '';
							if (buildingEl) buildingEl.value = selectedElevator.pastato_nr || '';
							if (postalEl) postalEl.value = selectedElevator.pasto_kodas || '';
						}

						if (omnivaGenerated) {
							if (generateLabelsBtn) generateLabelsBtn.classList.add('hidden');
						} else {
							if (generateLabelsBtn) generateLabelsBtn.classList.remove('hidden');
						}

						if (step4NextBtn) step4NextBtn.disabled = !omnivaGenerated;
					}

					if (stepNumber === 5) {
						const step5 = document.getElementById('step-5');
						if (!omnivaGenerated) {
							if (step5) step5.classList.add('opacity-50');
							if (step5SendBtn) step5SendBtn.disabled = true;
						} else {
							if (step5) step5.classList.remove('opacity-50');
							if (step5SendBtn) step5SendBtn.disabled = false;
						}
						startAttachmentsCooldown(10);
						if (step5SendBtn && !attachmentsAvailable()) step5SendBtn.disabled = true;
					}

					currentStep = stepNumber;
					updateProgressBar();
				};

				const validateAddSampleButton = () => {
					const isElevatorScenario = selectedScenario && selectedScenario.startsWith('elevator-');
					const elevatorOk = !isElevatorScenario || (isElevatorScenario && selectedElevator);
					btnAddSample.disabled = !(tempSelectedSupplier && tempSelectedAnnex && elevatorOk);
				};

				const validateStep2 = () => {
					step2NextBtn.disabled = selectedSamples.length === 0;
				};

				const resetAnnex = () => {
					annexContainer.classList.add('hidden');
					annexDetailsDiv.classList.add('hidden');
					annexSearchInput.value = '';
					tempSelectedAnnex = null;
					sampleCountContainer.classList.add('hidden');
					sampleCountInput.value = '1';
					validateAddSampleButton();
				};

				const resetSampleInputs = () => {
					supplierInput.value = '';
					tempSelectedSupplier = null;
					supplierAddressDiv.classList.add('hidden');
					supplierAddressDiv.innerHTML = '';
					resetAnnex();
				};

				const removeSample = index => {
					selectedSamples.splice(index, 1);
					renderSamplesList();
					validateStep2();
				};

				const renderSamplesList = () => {
					samplesList.innerHTML = '';
					if (selectedSamples.length === 0) {
						samplesList.appendChild(samplesListPlaceholder);
						samplesListPlaceholder.classList.remove('hidden');

						// Hide info and re-enable inputs
						if (shippingFromInfo) shippingFromInfo.classList.add('hidden');
						if (elevatorSelect) elevatorSelect.disabled = false;
						if (supplierInput) {
							supplierInput.disabled = false;
							supplierInput.value = '';
						}
						tempSelectedSupplier = null; // Clear temp supplier when list is empty
						resetAnnex();
					} else {
						samplesListPlaceholder.classList.add('hidden');

						// Show info and set location text
						if (shippingFromInfo) shippingFromInfo.classList.remove('hidden');
						const isElevatorSource = selectedScenario.startsWith('elevator-');

						if (isElevatorSource) {
							if (shippingFromLocation && selectedElevator) {
								shippingFromLocation.textContent = selectedElevator.pavadinimas;
							}
							if (elevatorSelect) elevatorSelect.disabled = true;
							// supplierInput remains enabled to add from other suppliers
						} else {
							// Farm or Office scenario
							const lockedSupplier = selectedSamples[0].supplier;
							if (shippingFromLocation && lockedSupplier) {
								shippingFromLocation.textContent = lockedSupplier.name;
							}
							if (supplierInput && lockedSupplier) {
								supplierInput.value = lockedSupplier.name;
								supplierInput.disabled = true;
								tempSelectedSupplier = lockedSupplier; // Lock the supplier for next add

								// Show and populate annexes for the locked supplier
								annexContainer.classList.remove('hidden');
								populateAnnexDropdown(lockedSupplier.priedai || lockedSupplier.annexes || []);
							}
						}

						selectedSamples.forEach((sample, index) => {
							const item = document.createElement('div');
							item.className =
								'flex justify-between items-center p-3 bg-white border border-gray-300 rounded-lg shadow-sm';
							let groupText = '';
							if (sample.groupTotal > 1) {
								groupText = ` <span class="text-xs text-gray-500 font-normal">(${sample.groupIndex}/${sample.groupTotal})</span>`;
							}
							item.innerHTML = `
                        <div class="text-sm">
                            <p class="font-bold text-gray-800">${sample.supplier.name}${groupText}</p>
                            <p class="text-gray-600">Priedas: <span class="font-medium text-red-600">${
															sample.annex.nr
														}</span> | Veislė: ${
								sample.annex.veisle || sample.annex.variety || 'N/A'
							}</p>
                        </div>
                        <button data-index="${index}" class="btn-remove-sample text-red-500 hover:text-red-700 font-semibold py-1 px-2">&times; Pašalinti</button>
                    `;
							samplesList.appendChild(item);
						});

						document.querySelectorAll('.btn-remove-sample').forEach(button => {
							button.addEventListener('click', e => {
								const index = parseInt(e.target.getAttribute('data-index'), 10);
								removeSample(index);
							});
						});
					}
				};

				btnAddSample.addEventListener('click', () => {
					if (!tempSelectedSupplier || !tempSelectedAnnex) return;

					const isElevatorScenario = selectedScenario.startsWith('elevator-');
					if (isElevatorScenario && !selectedElevator) {
						customAlert('Pasirinkite elevatorių, iš kurio siunčiama.');
						return;
					}

					const annexData = (tempSelectedSupplier.priedai || []).find(
						a => a.nr === tempSelectedAnnex
					);
					if (!annexData) return;

					const count = parseInt(sampleCountInput.value, 10) || 1;

					for (let i = 0; i < count; i++) {
						selectedSamples.push({
							supplier: tempSelectedSupplier,
							annex: annexData,
							sampleNumber: 'BJ25 M' + sampleCounter++,
							groupIndex: i + 1,
							groupTotal: count,
						});
					}

					renderSamplesList(); // This will set up the state correctly (e.g., lock supplier input)

					// After adding, clear the inputs for the *next* sample.
					if (isElevatorScenario) {
						// For elevator, clear supplier and annex to add a new one from scratch.
						resetSampleInputs();
					} else {
						// For farm, the supplier is locked by renderSamplesList. Just clear the annex selection.
						annexSearchInput.value = '';
						annexDetailsDiv.classList.add('hidden');
						tempSelectedAnnex = null;
						sampleCountContainer.classList.add('hidden');
						sampleCountInput.value = '1';
					}

					validateAddSampleButton(); // Re-validate the button. It should be disabled now.
					validateStep2(); // Validate the "Next" button.
				});

				const validateStep1 = () => {
					const scenarioChosen = !!document.querySelector('input[name="scenario"]:checked');
					const tokenVal = tokenInput ? tokenInput.value.trim() : '';
					const tokenPresent = !!tokenVal;
					const tokenInvalid = tokenHasInvalidChars(tokenVal);
					if (tokenInput) {
						tokenInput.classList.toggle('border-red-500', tokenInvalid);
					}
					step1NextBtn.disabled = !(scenarioChosen && tokenPresent && !tokenInvalid);
				};

				nextButtons.forEach(button => {
					button.addEventListener('click', () => {
						if (currentStep < totalSteps) {
							if (currentStep === 4) {
								if (!omnivaGenerated) {
									customAlert('Pirma sugeneruokite siuntos etiketę.');
									return;
								}
								const emailToInput = document.getElementById('email-to-input');
								const emailSubjectInput = document.getElementById('email-subject-input');
								const emailBodyInput = document.getElementById('email-body-input');

								const uniqueEmails = [
									...new Set(
										selectedSamples.map(s => s.supplier.email).filter(Boolean)
									),
								];
								emailToInput.value = uniqueEmails.join(', ');
								emailSubjectInput.value = `Mėginių paėmimas`;

								let formattedDateLT;
								if (pickupDateInput.value) {
									const dateObj = new Date(pickupDateInput.value);
									const userTimezoneOffset = dateObj.getTimezoneOffset() * 60000;
									const adjustedDate = new Date(dateObj.getTime() + userTimezoneOffset);
									formattedDateLT = adjustedDate.toLocaleDateString('lt-LT');
								} else {
									const deliveryDate = new Date();
									deliveryDate.setDate(new Date().getDate() + 3);
									formattedDateLT = deliveryDate.toLocaleDateString('lt-LT');
								}
								const shipStreet = (document.getElementById('ship-street') || {}).value || '';
								const shipBuilding = (document.getElementById('ship-building') || {}).value || '';
								const shipCity = (document.getElementById('ship-city') || {}).value || '';
								const shipPostal = (document.getElementById('ship-postal') || {}).value || '';
								const addressLine =
									`${shipStreet} ${shipBuilding}, ${shipCity}, ${shipPostal}`.trim();

								const samplesListForEmail = selectedSamples
									.map(s => {
										let groupText = '';
										if (s.groupTotal > 1) {
											groupText = ` (${s.groupIndex}/${s.groupTotal})`;
										}
										return `- ${s.supplier.name} (Sutarties priedas: ${s.annex.nr})${groupText}`;
									})
									.join('\n');

								const bodyText = `Sveiki,

Informuojame, kad ${formattedDateLT} bus paimami šie miežių mėginiai:
${samplesListForEmail}

Kurjeris atvyks ${formattedDateLT} | 12:00-13:30 | ${addressLine}.

Primename, kad adreso kortelės lipdukas klijuojamas ant siuntos kurjeriui.

Svarbu: Lipdukas mėginiui yra klijuojamas ant miežių mėginio pavyzdžio (2 kg). Jeigu mėginys bus be lipduko, kuris yra sukurtas jus identifikuoti, tyrimas laboratorijoje nebus atliekamas.

Pagarbiai/Kind regards,
Renata Bernotienė
Logistikos administratorė
UAB "Baltijos javai"`;

								emailBodyInput.value = bodyText;
							} else if (currentStep === 5) {
								const emailToInput = document.getElementById('email-to-input');
								const emailSubjectInput = document.getElementById('email-subject-input');
								const emailBodyInput = document.getElementById('email-body-input');
								const sendBtn = document.querySelector('#step-5 .btn-next');
								const sendingIndicator = document.getElementById('step5-sending');
								if (!attachmentsAvailable()) {
									const remain = Math.max(0, Math.ceil((attachmentsReadyAt - Date.now()) / 1000));
									customAlert('Failai ruošiami. Siuntimas galimas po ' + remain + ' s.');
									return;
								}
								if (!emailToInput.value || !emailToInput.value.trim()) {
									customAlert('Laukas "Kam" yra privalomas.');
									emailToInput.focus();
									return;
								}

								const emailPayloads = selectedSamples.map(sample => {
									const supplier = sample.supplier;
									const annex = sample.annex;
									return {
										to: emailToInput.value.trim(),
										subject: emailSubjectInput.value || '',
										body: emailBodyInput.value || '',
										clientId: supplier ? supplier.Id ?? supplier.id ?? null : null,
										sampleNumber: sample.sampleNumber,
										annex: annex ? annex.nr : null,
										pickupDate: pickupDateInput.value || null,
										scenario: selectedScenario || null,
										vadybininkas:
											(annex && (annex.vadybininkas || annex.manager)) ||
											(supplier && (supplier.vadybininkas || supplier.manager)) ||
											'',
									};
								});

								const headers = { accept: 'application/json', 'content-type': 'application/json' };
								if (authToken) headers['Authorization'] = authToken;
								if (sendBtn) sendBtn.disabled = true;
								if (sendingIndicator) sendingIndicator.classList.remove('hidden');

								const emailPromises = emailPayloads.map(payload =>
									fetch('https://operations.baltijosjavai.lt/webhook/send-email', {
										method: 'POST',
										headers,
										body: JSON.stringify(payload),
									}).then(resp => {
										if (!resp.ok) {
											console.error(`Failed to send email for sample ${payload.sampleNumber}`);
											throw new Error(`HTTP error ${resp.status} for sample ${payload.sampleNumber}`);
										}
										return resp.json().catch(() => ({}));
									})
								);

								Promise.all(emailPromises)
									.then(() => {
										showStep(currentStep + 1);
									})
									.catch(err => {
										console.error('Siuntimo klaida:', err);
										customAlert('Nepavyko išsiųsti vieno ar kelių el. laiškų. Bandykite dar kartą.');
									})
									.finally(() => {
										if (sendBtn) sendBtn.disabled = false;
										if (sendingIndicator) sendingIndicator.classList.add('hidden');
									});
								return;
							}
							showStep(currentStep + 1);
						}
					});
				});

				backButtons.forEach(button => {
					button.addEventListener('click', () => {
						if (currentStep > 1) showStep(currentStep - 1);
					});
				});

				scenarioRadios.forEach(radio => {
					radio.addEventListener('change', () => {
						validateStep1();
						const checkedRadio = document.querySelector('input[name="scenario"]:checked');
						selectedScenario = checkedRadio.value;
						selectedScenarioText = checkedRadio.nextElementSibling.textContent.trim();
					});
				});
				if (tokenInput) {
					tokenInput.addEventListener('input', () => {
						authToken = tokenInput.value.trim();
						validateStep1();
					});
				}

				step1NextBtn.addEventListener('click', async () => {
					const tokenVal = tokenInput ? tokenInput.value.trim() : '';
					if (tokenHasInvalidChars(tokenVal)) {
						customAlert('Rakte negalima lietuviškų raidžių!');
						return;
					}
					step1NextBtn.disabled = true;
					if (step1Loading) step1Loading.classList.remove('hidden');
					try {
						document.querySelectorAll('.scenario-display-text').forEach(el => {
							el.textContent = selectedScenarioText;
						});

						const isElevatorScenario = selectedScenario.startsWith('elevator-');

						if (isElevatorScenario) {
							await loadElevators(authToken);
							populateElevatorDropdown();
							elevatorContainer.classList.remove('hidden');
							supplierLabel.textContent = 'Iš kur atvežta (Tiekėjas)';
						} else {
							elevatorContainer.classList.add('hidden');
							if (selectedScenario === 'office-vm') {
								supplierLabel.textContent = 'Tiekėjas (kieno mėginys)';
							} else {
								// farm scenarios
								supplierLabel.textContent = 'Iš kur siunčiama (Tiekėjas)';
							}
						}

						await loadSuppliers(authToken);

						validateStep2();
						showStep(2);
					} catch (e) {
						console.error('Step 1→2 data load failed:', e);
						const msg =
							(e && e.message) ||
							'Nepavyko užkrauti duomenų. Patikrinkite prieigos žetoną ir bandykite dar kartą.';
						customAlert(msg);
					} finally {
						validateStep1();
						if (step1Loading) step1Loading.classList.add('hidden');
					}
				});

				document.getElementById('btn-restart').addEventListener('click', () => {
					selectedSamples = [];
					renderSamplesList();
					resetSampleInputs();
					selectedElevator = null;
					elevatorSelect.value = '';
					elevatorContainer.classList.add('hidden');
					elevatorAddressDiv.classList.add('hidden');
					supplierLabel.textContent = 'Iš kur siunčiama (Tiekėjas)';

					supplierInput.value = '';
					autocompleteList.classList.add('hidden');
					resetAnnex();
					scenarioRadios.forEach(r => (r.checked = false));
					step1NextBtn.disabled = true;
					selectedScenario = null;
					selectedScenarioText = '';
					document.querySelectorAll('.scenario-display-text').forEach(el => {
						el.textContent = '';
					});
					omnivaStickerPreview.classList.add('hidden');
					pickupDateInput.value = '';
					if (sampleCountInput) sampleCountInput.value = '1';
					generationSuccessMsg.classList.add('hidden');
					omnivaGenerated = false;
					if (step4NextBtn) step4NextBtn.disabled = true;
					if (generateLabelsBtn) generateLabelsBtn.classList.remove('hidden');
					const msg = document.getElementById('attachments-cooldown-msg');
					if (attachmentsCooldownTimer) clearInterval(attachmentsCooldownTimer);
					attachmentsCooldownTimer = null;
					attachmentsReadyAt = 0;
					if (msg) msg.classList.add('hidden');
					setAttachmentButtonsEnabled(true);
					if (step5SendBtn) step5SendBtn.disabled = true;
					showStep(1);
				});

				const step3DateInput = document.getElementById('step3-date');
				if (step3DateInput) {
					step3DateInput.addEventListener('change', () => {
						const val = step3DateInput.value;
						if (!val) return;
						showStep(3); // Re-render stickers
						if (pickupDateInput) pickupDateInput.value = val;
						const omnivaDateEl = document.getElementById('omniva-date');
						if (omnivaDateEl) omnivaDateEl.textContent = val;
					});
				}
				if (pickupDateInput) {
					pickupDateInput.addEventListener('change', () => {
						const val = pickupDateInput.value;
						if (!val) return;
						const step3DateEl = document.getElementById('step3-date');
						if (step3DateEl) step3DateEl.value = val;
						showStep(3); // Re-render stickers
						const omnivaDateEl = document.getElementById('omniva-date');
						if (omnivaDateEl) omnivaDateEl.textContent = val;
					});
				}

				generateLabelsBtn.addEventListener('click', () => {
					const requiredMap = [
						{ el: document.getElementById('ship-city'), label: 'Miestas' },
						{ el: document.getElementById('ship-street'), label: 'Gatvė' },
						{ el: document.getElementById('ship-postal'), label: 'Pašto kodas' },
					];
					const missing = requiredMap.filter(({ el }) => !el || !el.value || !el.value.trim());
					if (missing.length > 0) {
						customAlert(
							'Užpildykite visus privalomus adreso laukus: ' + missing.map(m => m.label).join(', ')
						);
						if (missing[0] && missing[0].el) missing[0].el.focus();
						return;
					}

					const selectedDate = pickupDateInput.value;
					if (!selectedDate) {
						customAlert('Nurodykite paėmimo datą.');
						pickupDateInput.focus();
						return;
					}

					customConfirm('Ar tikrai norite generuoti siuntos etiketę?', confirmed => {
						if (!confirmed) return;

						generateLabelsBtn.classList.add('hidden');
						const dateObj = new Date(selectedDate);
						const userTimezoneOffset = dateObj.getTimezoneOffset() * 60000;
						const adjustedDate = new Date(dateObj.getTime() + userTimezoneOffset);
						const formattedDateISO = adjustedDate.toISOString().split('T')[0];
						document.getElementById('omniva-date').textContent = formattedDateISO;

						const isElevatorScenario = selectedScenario.startsWith('elevator-');

						const updatePromises = selectedSamples.map(sample => {
							const payload = {
								sampleNumber: sample.sampleNumber,
								pickupDate: formattedDateISO,
								supplierId: sample.supplier ? sample.supplier.Id ?? sample.supplier.id ?? null : null,
								annexId: sample.annex ? sample.annex.Id ?? sample.annex.id ?? null : null,
								annex: sample.annex ? sample.annex.nr : null,
								quantity: sample.annex ? sample.annex.quantity || '' : '',
								variety: sample.annex ? sample.annex.veisle || sample.annex.variety || '' : '',
								scenario: selectedScenario,
								elevatorId:
									isElevatorScenario && selectedElevator
										? selectedElevator.Id || selectedElevator.id || null
										: null,
							};

							const headers = {
								accept: 'application/json',
								'content-type': 'application/json',
							};
							if (authToken) headers['Authorization'] = authToken;

							return fetch(UPDATE_ENDPOINT, {
								method: 'POST',
								headers,
								body: JSON.stringify(payload),
							}).then(resp => {
								if (!resp.ok) throw new Error(`Update failed for ${sample.sampleNumber}`);
							});
						});

						Promise.all(updatePromises)
							.then(() => {
								omnivaStickerPreview.classList.remove('hidden');
								showGenerationSuccessOnce();
								omnivaGenerated = true;
								if (step4NextBtn) step4NextBtn.disabled = false;
							})
							.catch(err => {
								console.error('Nepavyko atnaujinti mėginių per webhook:', err);
								customAlert(
									'Nepavyko atnaujinti vieno ar kelių mėginių. Patikrinkite prieigos žetoną ir bandykite dar kartą.'
								);
								generateLabelsBtn.classList.remove('hidden');
							});
					});
				});

				elevatorSelect.addEventListener('change', function () {
					const raw = this.value;
					const selectedIdStr = String(raw).trim();

					selectedElevator =
						(elevators ?? []).find(
							e => String(e.id ?? e.Id ?? e.ID ?? e.kodas ?? '').trim() === selectedIdStr
						) || null;
					if (
						selectedElevator &&
						selectedElevator.address &&
						typeof selectedElevator.address === 'object'
					) {
						const a = selectedElevator.address;
						const full = [a.street, a.building || a.building_number, a.city, a.postal_code]
							.filter(Boolean)
							.join(', ');
						if (full) {
							elevatorAddressDiv.innerHTML = `<strong>Adresas:</strong> ${full}`;
							elevatorAddressDiv.classList.remove('hidden');
						} else {
							elevatorAddressDiv.classList.add('hidden');
							elevatorAddressDiv.innerHTML = '';
						}
					} else {
						elevatorAddressDiv.classList.add('hidden');
						elevatorAddressDiv.innerHTML = '';
					}
					validateAddSampleButton();
				});

				supplierInput.addEventListener('input', function () {
					const val = this.value;
					closeAllLists();
					resetAnnex();
					tempSelectedSupplier = null;
					validateAddSampleButton();

					if (!val) return false;

					autocompleteList.innerHTML = '';
					autocompleteList.classList.remove('hidden');

					suppliers.forEach(supplier => {
						if (supplier.name.toUpperCase().includes(val.toUpperCase())) {
							const item = document.createElement('div');
							item.innerHTML = `<strong>${supplier.name.substr(
								0,
								val.length
							)}</strong>${supplier.name.substr(val.length)}`;
							item.addEventListener('click', function () {
								supplierInput.value = supplier.name;
								tempSelectedSupplier = supplier;
								let hasAddress = false;
								if (supplier && supplier.address && typeof supplier.address === 'object') {
									const a = supplier.address;
									const full = [a.street, a.building || a.building_number, a.city, a.postal_code]
										.filter(Boolean)
										.join(', ');
									if (full) {
										supplierAddressDiv.innerHTML = `<strong>Adresas:</strong> ${full}`;
										supplierAddressDiv.classList.remove('hidden');
										hasAddress = true;
									}
								}
								if (!hasAddress) {
									supplierAddressDiv.classList.add('hidden');
									supplierAddressDiv.innerHTML = '';
								}
								closeAllLists();

								annexContainer.classList.remove('hidden');
								populateAnnexDropdown(supplier.priedai || supplier.annexes || []);
								validateAddSampleButton();
							});
							autocompleteList.appendChild(item);
						}
					});
				});

				function populateAnnexDropdown(annexes) {
					annexDropdown.innerHTML = '';
					annexes.forEach(annex => {
						const item = document.createElement('div');
						item.classList.add(
							'flex',
							'justify-between',
							'items-center',
							'w-full',
							'p-2',
							'text-sm',
							'cursor-pointer',
							'border-b',
							'hover:bg-gray-100'
						);
						item.innerHTML = `
                <span class="font-semibold text-red-500 w-1/4">${annex.nr}</span>
                <span class="text-gray-600 w-1/4"><strong class="font-medium">Priedo data:</strong> ${
									annex.date
								}</span>
                <span class="text-gray-600 w-1/4"><strong class="font-medium">Kiekis:</strong> ${
									annex.quantity
								}</span>
                <span class="text-gray-600 w-1/4"><strong class="font-medium">Veislė:</strong> ${
									annex.veisle || annex.variety || 'Nenurodyta'
								}</span>
            `;
						item.addEventListener('click', function () {
							annexSearchInput.value = annex.nr;
							tempSelectedAnnex = annex.nr;
							annexDetailsDiv.innerHTML = `
                        <strong>Priedo data:</strong> ${annex.date} |
                        <strong>Kiekis:</strong> ${annex.quantity} |
                        <strong>Veislė:</strong> ${annex.veisle || annex.variety || 'Nenurodyta'}`;
							annexDetailsDiv.classList.remove('hidden');
							sampleCountContainer.classList.remove('hidden');
							annexDropdown.classList.add('hidden');
							validateAddSampleButton();
						});
						annexDropdown.appendChild(item);
					});
				}

				annexSearchInput.addEventListener('input', function () {
					const filter = this.value.toUpperCase();
					const items = annexDropdown.getElementsByTagName('div');
					for (let i = 0; i < items.length; i++) {
						const txtValue = items[i].textContent || items[i].innerText;
						items[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
					}
				});

				annexSearchInput.addEventListener('focus', () => annexDropdown.classList.remove('hidden'));

				function closeAllLists(elmnt) {
					autocompleteList.classList.add('hidden');
					if (elmnt !== annexSearchInput) {
						annexDropdown.classList.add('hidden');
					}
				}

				document.addEventListener('click', function (e) {
					closeAllLists(e.target);
				});

				// --- Register View Logic ---
				const showRegister = async () => {
					if (!mainProcessContainer || !registerView) return;

					mainProcessContainer.classList.add('hidden');
					registerView.classList.remove('hidden');

					const tbody = document.getElementById('register-table-body');
					if (!tbody) return;

					tbody.innerHTML = '<tr><td colspan="11" class="text-center p-4">Kraunama...</td></tr>';

					if (!authToken) {
						customAlert(
							'Norėdami peržiūrėti registrą, pirmame žingsnyje įveskite galiojantį prieigos raktą.'
						);
						tbody.innerHTML =
							'<tr><td colspan="11" class="text-center p-4">Reikalingas prieigos raktas.</td></tr>';
						return;
					}

					try {
						const headers = { accept: 'application/json', Authorization: authToken };
						const url = new URL(GET_SAMPLES_ENDPOINT);
						if (selectedScenario) url.searchParams.set('scenario', selectedScenario);
						const resp = await fetch(url.toString(), { method: 'GET', headers });

						if (!resp.ok) {
							if (resp.status === 400) {
								tbody.innerHTML =
									'<tr><td colspan="11" class="text-center p-4">Duomenų bazėje mėginių nėra.</td></tr>';
								return;
							}

							let errorMsg = `HTTP ${resp.status}`;
							try {
								const errorJson = await resp.json();
								if (errorJson && errorJson.message) {
									errorMsg = errorJson.message;
								}
							} catch (e) {}
							throw new Error(errorMsg);
						}

						const samples = await resp.json();
						registerRowsOriginal = Array.isArray(samples?.data) ? samples.data : [];
						renderRegisterTable(tbody);
					} catch (err) {
						console.error('Klaida gaunant registrą:', err);
						tbody.innerHTML = `<tr><td colspan="11" class="text-center p-4 text-red-500">Nepavyko užkrauti registro duomenų. Klaida: ${err.message}</td></tr>`;
					}
				};

				if (openRegisterBtn) {
					openRegisterBtn.addEventListener('click', () => {
						const tokenVal = tokenInput ? tokenInput.value.trim() : '';
						if (tokenHasInvalidChars(tokenVal)) {
							customAlert('Rakte negalima lietuviškų raidžių!');
							return;
						}
						showRegister();
					});
				}

				if (backToMainBtn) {
					backToMainBtn.addEventListener('click', () => {
						if (!mainProcessContainer || !registerView) return;
						registerView.classList.add('hidden');
						mainProcessContainer.classList.remove('hidden');
					});
				}

				if (openRegisterSuccessBtn) {
					openRegisterSuccessBtn.addEventListener('click', () => {
						const tokenVal = tokenInput ? tokenInput.value.trim() : '';
						if (tokenHasInvalidChars(tokenVal)) {
							customAlert('Rakte negalima lietuviškų raidžių!');
							return;
						}
						showRegister();
					});
				}

				if (goStartBtn) {
					goStartBtn.addEventListener('click', () => {
						showStep(1);
					});
				}

				if (thPaemimo) {
					thPaemimo.addEventListener('click', () => {
						const tbody = document.getElementById('register-table-body');
						if (registerSortKey === 'paemimo_data') {
							registerSortDir = registerSortDir === 'asc' ? 'desc' : 'asc';
						} else {
							registerSortKey = 'paemimo_data';
							registerSortDir = 'asc';
						}
						renderRegisterTable(tbody);
					});
				}
				if (thMeginio) {
					thMeginio.addEventListener('click', () => {
						const tbody = document.getElementById('register-table-body');
						if (registerSortKey === 'kodas') {
							registerSortDir = registerSortDir === 'asc' ? 'desc' : 'asc';
						} else {
							registerSortKey = 'kodas';
							registerSortDir = 'asc';
						}
						renderRegisterTable(tbody);
					});
				}
				if (thBusena) {
					thBusena.addEventListener('click', () => {
						const tbody = document.getElementById('register-table-body');
						if (registerSortKey === 'busena') {
							registerSortDir = registerSortDir === 'asc' ? 'desc' : 'asc';
						} else {
							registerSortKey = 'busena';
							registerSortDir = 'asc';
						}
						renderRegisterTable(tbody);
					});
				}
				if (registerAnnexFilterInput) {
					registerAnnexFilterInput.addEventListener('input', () => {
						registerAnnexFilter = registerAnnexFilterInput.value.trim();
						const tbody = document.getElementById('register-table-body');
						renderRegisterTable(tbody);
					});
				}

				// Set initial date for step 3
				const today = new Date();
				const formattedDateISO = today.toISOString().split('T')[0];
				if (step3DateInput) step3DateInput.value = formattedDateISO;
			});
		</script>
	</body>
</html>



