<!DOCTYPE html>
<html lang="lt">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Mėginių Paėmimo Prototipas</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
			rel="stylesheet" />
		<style>
			body {
				font-family: 'Inter', sans-serif;
			}
			.step-card {
				transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
			}
			.hidden-step {
				display: none;
				opacity: 0;
				transform: scale(0.95);
			}
			.visible-step {
				display: block;
				opacity: 1;
				transform: scale(1);
			}
			.autocomplete-items div,
			.dropdown-items div {
				padding: 10px;
				cursor: pointer;
				background-color: #fff;
				border-bottom: 1px solid #ddd;
			}
			.autocomplete-items div:hover,
			.dropdown-items div:hover {
				background-color: #e9e9e9;
			}
			.autocomplete-active {
				background-color: DodgerBlue !important;
				color: #ffffff;
			}
			.barcode {
				font-family: 'Libre Barcode 39', cursive;
				font-size: 48px;
				line-height: 1;
			}
		</style>
		<link
			href="https://fonts.googleapis.com/css2?family=Libre+Barcode+39&display=swap"
			rel="stylesheet" />
	</head>
	<body class="bg-gray-100 flex items-center justify-center min-h-screen">
		<div class="w-full max-w-5xl mx-auto p-4" id="main-process-container">
			<div class="px-4 sm:px-0">
				<div class="flex items-center justify-between mb-4">
					<div class="flex items-center">
						<svg
							xmlns="http://www.w3.org/2000/svg"
							width="32"
							height="32"
							viewBox="0 0 256 256"
							class="text-blue-600 mr-3">
							<path
								fill="currentColor"
								d="M216 72h-12.82A63.95 63.95 0 0 0 89.67 48.27L72.24 35.84A8 8 0 0 0 60.27 32H40a8 8 0 0 0 0 16h17.73l17.43 12.43A64.12 64.12 0 0 0 80 128a63.38 63.38 0 0 0 4.28 22.88a32 32 0 1 0 15.44 15.44A64 64 0 0 0 216 136V80a8 8 0 0 0-8-8M56 200a16 16 0 1 1 16 16a16 16 0 0 1-16-16m152-72h-72a56 56 0 0 1-52.2-35.34A56.24 56.24 0 0 1 136 80h72Z" />
						</svg>
						<h1 class="text-2xl font-bold text-gray-800">Mėginių Siuntimo Procesas</h1>
					</div>
					<div class="space-x-2">
						<button
							id="btn-open-register"
							class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
							Mėginių registras
						</button>
						<button
							id="btn-go-start"
							class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
							Į pradžią
						</button>
					</div>
				</div>
				<div class="relative w-full bg-gray-200 rounded-full h-2.5 mb-6">
					<div
						id="progressBar"
						class="bg-blue-600 h-2.5 rounded-full"
						style="width: 0%; transition: width 0.3s ease-in-out"></div>
				</div>
			</div>

			<div id="step-1" class="step-card bg-white p-8 rounded-xl shadow-lg visible-step">
				<h2 class="text-xl font-semibold text-gray-700 mb-1">1. Scenarijaus Pasirinkimas</h2>
				<p class="text-gray-500 mb-6">Pasirinkite mėginio siuntimo scenarijų.</p>
				<div id="scenarioOptions" class="space-y-3">
					<label
						class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-500 transition-all">
						<input
							type="radio"
							name="scenario"
							value="farm-vm"
							class="h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500" />
						<span class="ml-4 text-gray-800 font-medium">Ūkis -&gt; Viking Malt (VM)</span>
					</label>
					<label
						class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-500 transition-all">
						<input
							type="radio"
							name="scenario"
							value="elevator-vm"
							class="h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500" />
						<span class="ml-4 text-gray-800 font-medium">Elevatorius -&gt; Viking Malt (VM)</span>
					</label>
					<label
						class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-500 transition-all">
						<input
							type="radio"
							name="scenario"
							value="elevator-biliunai"
							class="h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500" />
						<span class="ml-4 text-gray-800 font-medium"
							>Elevatorius -&gt; BILIŪNAI Elevatorius</span
						>
					</label>
					<label
						class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-500 transition-all">
						<input
							type="radio"
							name="scenario"
							value="elevator-office"
							class="h-5 w-5 text-blue-600 border-gray-300 focus:ring-blue-500" />
						<span class="ml-4 text-gray-800 font-medium">Elevatorius -&gt; Ofisas</span>
					</label>
				</div>
				<div class="mt-4">
					<label for="auth-token" class="block text-sm font-medium text-gray-700"
						>Prieigos raktas</label
					>
					<input
						type="password"
						id="auth-token"
						class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
						placeholder="Įveskite raktą duomenų užklausai" />
					<p class="text-xs text-gray-500 mt-1">Raktas naudojamas vartotojo atpažinimui.</p>
				</div>
				<div class="mt-8 text-right">
					<button
						id="btn-step1-next"
						class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400 disabled:cursor-not-allowed"
						disabled>
						Toliau
					</button>
					<span id="step1-loading" class="hidden inline-flex items-center ml-3 text-blue-600">
						<svg
							class="animate-spin h-5 w-5 mr-2"
							xmlns="http://www.w3.org/2000/svg"
							fill="none"
							viewBox="0 0 24 24">
							<circle
								class="opacity-25"
								cx="12"
								cy="12"
								r="10"
								stroke="currentColor"
								stroke-width="4"></circle>
							<path
								class="opacity-75"
								fill="currentColor"
								d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
						</svg>
						Kraunama...
					</span>
				</div>
			</div>

			<div id="step-2" class="step-card bg-white p-8 rounded-xl shadow-lg hidden-step">
				<div class="mb-4">
					<span class="text-red-500 font-semibold">Scenarijus:</span>
					<span class="text-gray-700 font-medium ml-2 scenario-display-text"></span>
				</div>
				<h2 class="text-xl font-semibold text-gray-700 mb-1">2. Duomenų įvedimas</h2>
				<p class="text-gray-500 mb-6">
					Įveskite siuntėjo informaciją ir pasirinkite sutarties priedą.
				</p>
				<div class="space-y-6">
					<div id="elevator-container" class="hidden">
						<label for="elevator-select" class="block text-sm font-medium text-gray-700 mb-1"
							>Iš kur siunčiama (Elevatorius)</label
						>
						<select
							id="elevator-select"
							class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></select>
						<div
							id="elevator-address"
							class="mt-2 text-sm text-gray-600 p-3 bg-gray-50 rounded-md border border-gray-200 hidden"></div>
					</div>

					<div class="relative">
						<label for="supplier" class="block text-sm font-medium text-gray-700 mb-1"
							>Iš kur siunčiama (Tiekėjas)</label
						>
						<input
							type="text"
							id="supplier"
							name="supplier"
							autocomplete="off"
							class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
							placeholder="Pradėkite vesti ūkio pavadinimą..." />
						<div
							id="autocomplete-list"
							class="absolute z-20 w-full bg-white border border-gray-300 rounded-b-md shadow-lg hidden autocomplete-items"></div>
						<div
							id="supplier-address"
							class="mt-2 text-sm text-gray-600 p-3 bg-gray-50 rounded-md border border-gray-200 hidden"></div>
					</div>

					<div id="annex-container" class="hidden">
						<label for="annex-search" class="block text-sm font-medium text-gray-700"
							>Priedo numeris</label
						>
						<div class="relative mt-1">
							<input
								type="text"
								id="annex-search"
								placeholder="Pasirinkite arba ieškokite..."
								autocomplete="off"
								class="w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
							<div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
								<svg
									class="h-5 w-5 text-gray-400"
									xmlns="http://www.w3.org/2000/svg"
									viewBox="0 0 20 20"
									fill="currentColor"
									aria-hidden="true">
									<path
										fill-rule="evenodd"
										d="M10 3a.75.75 0 01.53.22l3.5 3.5a.75.75 0 01-1.06 1.06L10 4.81 6.53 8.28a.75.75 0 01-1.06-1.06l3.5-3.5A.75.75 0 0110 3zm-3.72 9.28a.75.75 0 011.06 0L10 15.19l2.47-2.47a.75.75 0 111.06 1.06l-3.5 3.5a.75.75 0 01-1.06 0l-3.5-3.5a.75.75 0 010-1.06z"
										clip-rule="evenodd" />
								</svg>
							</div>
							<div
								id="annex-dropdown"
								class="absolute hidden z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto dropdown-items"></div>
						</div>
						<div
							id="annex-details"
							class="mt-2 text-sm text-gray-600 p-3 bg-gray-50 rounded-md border border-gray-200 hidden"></div>
					</div>
				</div>
				<div class="mt-8 flex justify-between">
					<button
						class="btn-back bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
						Atgal
					</button>
					<button
						id="btn-step2-next"
						class="btn-next bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400"
						disabled>
						Toliau
					</button>
				</div>
			</div>

			<div id="step-3" class="step-card bg-white p-8 rounded-xl shadow-lg hidden-step">
				<div class="mb-4">
					<span class="text-red-500 font-semibold">Scenarijus:</span>
					<span class="text-gray-700 font-medium ml-2 scenario-display-text"></span>
				</div>
				<h2 class="text-xl font-semibold text-gray-700 mb-1">3. Lipdukas Mėginiui</h2>
				<p class="text-gray-500 mb-6">Patikrinkite sugeneruotą lipduką ir įveskite kiekį.</p>

				<div class="mb-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
					<div>
						<label for="step3-date" class="block text-sm font-medium text-gray-700 font-bold"
							>Paėmimo data:</label
						>
						<input
							type="date"
							id="step3-date"
							class="mt-1 block w-full max-w-xs px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
					</div>
					<div>
						<label for="quantity-input" class="block text-sm font-medium text-gray-700 font-bold"
							>Kiekis:</label
						>
						<input
							type="text"
							id="quantity-input"
							class="mt-1 block w-full max-w-xs px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
							placeholder="pvz., 150t" />
					</div>
				</div>

				<div class="space-y-6">
					<div class="border-2 border-dashed rounded-lg p-4 bg-gray-50">
						<h3 class="font-bold text-center text-gray-800 mb-2">Mėginio lipdukas</h3>
						<div class="grid grid-cols-2 gap-0 border bg-white shadow-sm p-2">
							<div class="p-2 border-r">
								<div class="text-left mb-2 pb-2">
									<p class="font-bold text-sm">BALTIJOS JAVAI</p>
									<p class="text-xs text-gray-600">Siuntėjas: UAB "Baltijos javai"</p>
									<p class="text-xs text-gray-600">Svirbygalos g. 19, Lithuania</p>
								</div>
								<div class="space-y-1 text-xs">
									<p>
										<span class="font-semibold">Paėmimo data:</span>
										<span class="label-date"></span>
									</p>
									<p>
										<span class="font-semibold">Veislė:</span>
										<span class="label-variety"></span>
									</p>
									<p>
										<span class="font-semibold">Kiekis:</span> <span class="label-quantity"></span>
									</p>
								</div>
								<div class="mt-2 h-16 border-t border-gray-200"></div>
							</div>

							<div class="p-2">
								<div class="text-left mb-2 pb-2">
									<p class="font-bold text-sm">BALTIJOS JAVAI</p>
									<p class="text-xs text-gray-600">Siuntėjas: UAB "Baltijos javai"</p>
									<p class="text-xs text-gray-600">Svirbygalos g. 19, Lithuania</p>
								</div>
								<div class="space-y-1 text-xs">
									<p>
										<span class="font-semibold">Paėmimo data:</span>
										<span class="label-date"></span>
									</p>
									<p>
										<span class="font-semibold">Veislė:</span>
										<span class="label-variety"></span>
									</p>
									<p>
										<span class="font-semibold">Kiekis:</span> <span class="label-quantity"></span>
									</p>
								</div>
								<div class="mt-2 h-16 border-t border-gray-200"></div>
							</div>
						</div>
					</div>
				</div>
				<div class="mt-8 flex justify-between">
					<button
						class="btn-back bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
						Atgal
					</button>
					<button
						class="btn-next bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">
						Toliau
					</button>
				</div>
			</div>

			<div id="step-4" class="step-card bg-white p-8 rounded-xl shadow-lg hidden-step">
				<div class="mb-4">
					<span class="text-red-500 font-semibold">Scenarijus:</span>
					<span class="text-gray-700 font-medium ml-2 scenario-display-text"></span>
				</div>
				<h2 class="text-xl font-semibold text-gray-700 mb-1">4. Siuntos Užsakymas</h2>
				<p class="text-gray-500 mb-6">Pasirinkite paėmimo datą ir sugeneruokite siuntos lipduką.</p>

				<div class="border-2 border-dashed rounded-lg p-4 bg-gray-50">
					<div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 mb-4 pb-4 border-b">
						<div>
							<h3 class="text-lg font-semibold text-blue-600">Mėginys bus paimtas iš:</h3>
							<div id="pickup-display-info" class="mt-2 text-gray-800 text-sm">
								<p class="font-bold" id="pickup-display-name"></p>
								<p id="pickup-display-address"></p>
							</div>
						</div>
						<div>
							<h3 class="text-lg font-semibold text-red-600">Kur pristatyti mėginį</h3>
							<div id="recipient-display-info" class="mt-2 text-gray-800 text-sm">
								<p class="font-bold" id="recipient-display-name"></p>
								<p id="recipient-display-address"></p>
								<p id="recipient-display-contact-person"></p>
								<p id="recipient-display-phone"></p>
							</div>
						</div>
					</div>
					<div class="text-center mb-4 border-b pb-4">
						<h4 class="text-md font-semibold text-red-600 mb-4">
							Informacija kurjeriui iš kur paimti mėginį
						</h4>
						<div class="mt-4 flex flex-col sm:flex-row items-center justify-center gap-4">
							<div>
								<label for="pickup-date" class="block text-sm font-medium text-gray-700 text-left"
									>Kada paimti:</label
								>
								<input
									type="date"
									id="pickup-date"
									class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
							</div>
							<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full sm:w-auto">
								<div>
									<label for="ship-city" class="block text-sm font-medium text-gray-700 text-left"
										>Miestas</label
									>
									<input
										id="ship-city"
										type="text"
										class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
								</div>
								<div>
									<label for="ship-street" class="block text-sm font-medium text-gray-700 text-left"
										>Gatvė</label
									>
									<input
										id="ship-street"
										type="text"
										class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
								</div>
								<div>
									<label
										for="ship-building"
										class="block text-sm font-medium text-gray-700 text-left"
										>Pastato nr.</label
									>
									<input
										id="ship-building"
										type="text"
										class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
								</div>
								<div>
									<label for="ship-postal" class="block text-sm font-medium text-gray-700 text-left"
										>Pašto kodas</label
									>
									<input
										id="ship-postal"
										type="text"
										class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
								</div>
								<div>
									<label for="ship-name" class="block text-sm font-medium text-gray-700 text-left"
										>Vardas</label
									>
									<input
										id="ship-name"
										type="text"
										class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
								</div>
								<div>
									<label for="ship-phone" class="block text-sm font-medium text-gray-700 text-left"
										>Telefono Nr.</label
									>
									<input
										id="ship-phone"
										type="text"
										class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
								</div>
							</div>
							<button
								id="generate-labels-btn"
								class="self-end sm:self-center bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 mt-2 sm:mt-0 whitespace-nowrap">
								Generuoti siuntos etiketę
							</button>
						</div>
						<div
							id="generation-success-msg"
							class="hidden mt-3 text-sm font-semibold text-green-600 flex items-center justify-center">
							<svg
								xmlns="http://www.w3.org/2000/svg"
								class="h-5 w-5 mr-2"
								viewBox="0 0 20 20"
								fill="currentColor">
								<path
									fill-rule="evenodd"
									d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
									clip-rule="evenodd" />
							</svg>
							<span>Etiketė sėkmingai sugeneruota!</span>
						</div>
					</div>

					<div id="omniva-sticker-preview" class="hidden">
						<h3 class="font-bold text-center text-gray-800 mb-2">Siuntos lipdukas</h3>
						<div class="bg-white p-4 rounded-md shadow-sm border text-gray-800">
							<div class="flex justify-between items-start pb-2 border-b">
								<div>
									<p class="text-xs mt-1">Siunta - Kurjeris</p>
								</div>
								<div class="text-right">
									<svg class="w-12 h-12" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
										<path
											fill="currentColor"
											d="M140 140h28v28h-28v-28Zm-56-56H56v28h28V84Zm0 56H56v28h28v-28Zm56-56h28v28h-28V84Zm56 0h28v28h-28V84Zm-56 56h28v28h-28v-28Zm56 0h28v28h-28v-28Zm-56 56h28v28h-28v-28Zm-28-28a12 12 0 1 1-12-12a12 12 0 0 1 12 12Zm112 0h28v28h-28v-28Zm-56 56h28v28h-28v-28Zm-56-56H56v28h28v-28Zm0-56H56v28h28V84Zm168 56h28v28h-28v-28ZM40 40a16 16 0 0 0-16 16v40H8a8 8 0 0 0 0 16h16v40H8a8 8 0 0 0 0 16h16v40a16 16 0 0 0 16 16h40v16a8 8 0 0 0 16 0v-16h40v16a8 8 0 0 0 16 0v-16h40v16a8 8 0 0 0 16 0v-16h40a16 16 0 0 0 16-16v-40h16a8 8 0 0 0 0-16h-16V96h16a8 8 0 0 0 0-16h-16V56a16 16 0 0 0-16-16H56A16 16 0 0 0 40 40Zm16 16h144v144H56V56Z" />
									</svg>
									<p class="text-sm font-mono mt-1" id="omniva-date"></p>
								</div>
							</div>
							<div class="grid grid-cols-6 gap-3 mt-3">
								<div
									class="col-span-1 text-xs font-bold transform -rotate-90 origin-center self-center text-center tracking-widest">
									SIUNTĖJAS
								</div>
								<div class="col-span-5 text-xs pl-2">
									<p class="font-bold">Baltijos Javai UAB</p>
									<p>Kauno m. Svirbygalos g. 19, LT-46280</p>
									<p>Kauno m. sav., Kauno apskr. Lietuva</p>
								</div>
							</div>
							<div class="grid grid-cols-6 gap-3 mt-3 pt-2 border-t">
								<div
									class="col-span-1 text-xs font-bold transform -rotate-90 origin-center self-center text-center tracking-widest">
									GAVĖJAS
								</div>
								<div class="col-span-5 text-xs pl-2">
									<p class="font-bold" id="recipient-name">UAB Viking Malt</p>
									<p id="recipient-contact">Dovydas</p>
									<p id="recipient-address-line1">
										Panevėžio m. Pramonės g. 2, LT-35289, Panevėžys
									</p>
									<p class="mt-1">
										<svg
											xmlns="http://www.w3.org/2000/svg"
											class="h-3 w-3 inline-block mr-1"
											viewBox="0 0 20 20"
											fill="currentColor">
											<path
												d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
										</svg>
										<span id="recipient-phone">+370 691 51153</span>
									</p>
								</div>
							</div>
							<div class="py-2 mt-2 border-y">
								<p class="text-xs font-semibold">Būtinai pasiskambinti prieš atvykstant</p>
							</div>
						</div>
					</div>
				</div>
				<div class="mt-8 flex justify-between">
					<button
						class="btn-back bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
						Atgal
					</button>
					<button
						class="btn-next bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
						Toliau
					</button>
				</div>
			</div>

			<div id="step-5" class="step-card bg-white p-8 rounded-xl shadow-lg hidden-step">
				<div class="mb-4">
					<span class="text-red-500 font-semibold">Scenarijus:</span>
					<span class="text-gray-700 font-medium ml-2 scenario-display-text"></span>
				</div>
				<h2 class="text-xl font-semibold text-gray-700 mb-1">5. El. laiško siuntimas</h2>
				<p class="text-gray-500 mb-6">
					Patikrinkite suformuotą el. laišką ūkiui ir prisegtus dokumentus.
				</p>
				<div class="border rounded-lg overflow-hidden bg-white shadow-sm">
					<div class="p-4 border-b bg-gray-50 space-y-2">
						<div>
							<label for="email-to-input" class="text-sm font-medium text-gray-500">Kam:</label>
							<input
								type="email"
								id="email-to-input"
								class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
						</div>
						<div>
							<label for="email-subject-input" class="text-sm font-medium text-gray-500"
								>Tema:</label
							>
							<input
								type="text"
								id="email-subject-input"
								class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
						</div>
					</div>
					<div class="p-4">
						<label for="email-body-input" class="text-sm font-medium text-gray-500"
							>Laiško tekstas:</label
						>
						<textarea
							id="email-body-input"
							rows="10"
							class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
						<div class="mt-2 text-sm text-red-600">
							Svarbu: jeigu mėginys bus be lipduko, kuris yra sukurtas jus identifikuoti, tyrimas
							laboratorijoje nebus atliekamas.
						</div>
					</div>

					<div class="p-4 border-t bg-gray-50">
						<h4 class="text-sm font-semibold mb-2 text-gray-600">Prisegtukai (2):</h4>
						<div
							id="attachments-cooldown-msg"
							class="hidden text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded px-2 py-1 mb-2">
							Failai ruošiami. Galėsite atsisiųsti po
							<span id="attachments-cooldown-seconds">10</span> s.
						</div>
						<div class="flex space-x-3">
							<button
								id="download-sample-sticker"
								class="flex items-center bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full hover:bg-blue-200 cursor-pointer">
								<svg
									class="w-4 h-4 mr-1.5"
									fill="none"
									stroke="currentColor"
									viewBox="0 0 24 24"
									xmlns="http://www.w3.org/2000/svg">
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
								</svg>
								meginio_lipdukas.pdf
							</button>
							<button
								id="download-post-sticker"
								class="flex items-center bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-1 rounded-full hover:bg-blue-200 cursor-pointer">
								<svg
									class="w-4 h-4 mr-1.5"
									fill="none"
									stroke="currentColor"
									viewBox="0 0 24 24"
									xmlns="http://www.w3.org/2000/svg">
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
								</svg>
								siuntos_lipdukas.pdf
							</button>
						</div>
					</div>
				</div>
				<div class="mt-8 flex justify-between">
					<button
						class="btn-back bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300">
						Atgal
					</button>
					<div class="flex items-center">
						<button
							class="btn-next bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
							Siųsti
						</button>
						<span id="step5-sending" class="hidden inline-flex items-center ml-3 text-green-600">
							<svg
								class="animate-spin h-5 w-5 mr-2"
								xmlns="http://www.w3.org/2000/svg"
								fill="none"
								viewBox="0 0 24 24">
								<circle
									class="opacity-25"
									cx="12"
									cy="12"
									r="10"
									stroke="currentColor"
									stroke-width="4"></circle>
								<path
									class="opacity-75"
									fill="currentColor"
									d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
							</svg>
							Siunčiama...
						</span>
					</div>
				</div>
			</div>

			<div id="step-6" class="step-card bg-white p-8 rounded-xl shadow-lg hidden-step">
				<div class="text-center">
					<div class="mb-4">
						<span class="text-red-500 font-semibold">Scenarijus:</span>
						<span class="text-gray-700 font-medium ml-2 scenario-display-text"></span>
					</div>
					<div
						class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4">
						<svg
							class="h-10 w-10 text-green-600"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
							xmlns="http://www.w3.org/2000/svg">
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M5 13l4 4L19 7"></path>
						</svg>
					</div>
					<h2 class="text-2xl font-bold text-gray-800">Sėkmingai išsiųsta!</h2>
					<p class="text-gray-500 mt-2 mb-6">
						Laiškas ir dokumentai buvo sėkmingai išsiųsti tiekėjui.
					</p>
				</div>
				<div class="mt-8 flex items-center justify-center space-x-4">
					<button
						id="btn-open-register-success"
						class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700">
						Mėginių registras
					</button>
					<button
						id="btn-restart"
						class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">
						Pradėti iš naujo
					</button>
				</div>
			</div>
		</div>

		<div id="register-view" class="w-full max-w-7xl mx-auto p-2 hidden">
			<div class="bg-white p-6 rounded-xl shadow-lg">
				<h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
					Išsiųstų Mėginių Registras
				</h2>
				<div class="mb-4">
					<label for="register-annex-filter" class="block text-sm font-medium text-gray-700 mb-1"
						>Filtruoti pagal "Sutarties priedas"</label
					>
					<input
						id="register-annex-filter"
						type="text"
						placeholder="Įveskite priedo numerį ar pavadinimą..."
						class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" />
				</div>
				<div class="overflow-x-auto border rounded-lg">
					<table class="min-w-full divide-y divide-gray-200 text-sm">
						<thead class="bg-gray-50">
							<tr>
								<th
									class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
									Vadybininkas
								</th>
								<th
									id="th-paemimo-data"
									class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer select-none">
									Paėmimo Data
									<span class="inline-block text-gray-400" id="sort-ind-paemimo">↕</span>
								</th>
								<th
									id="th-meginio-nr"
									class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer select-none">
									Mėginio Nr.
									<span class="inline-block text-gray-400" id="sort-ind-meginio">↕</span>
								</th>
								<th
									class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
									Tiekėjas
								</th>
								<th
									class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
									Paėmimo Vieta
								</th>
								<th
									class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
									Siunčiama į
								</th>
								<th
									class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
									Sutarties Priedas
								</th>
								<th
									class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
									Būsena
								</th>
							</tr>
						</thead>
						<tbody id="register-table-body" class="bg-white divide-y divide-gray-200"></tbody>
					</table>
				</div>
				<div class="mt-8 text-center">
					<button
						id="btn-back-to-main"
						class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">
						Atgal į procesą
					</button>
				</div>
			</div>
		</div>

		<div
			id="custom-modal"
			class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
			<div class="relative mx-auto p-5 border w-full max-w-sm shadow-lg rounded-xl bg-white">
				<div class="mt-3 text-center">
					<div
						class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
						<svg
							class="h-6 w-6 text-blue-600"
							fill="none"
							stroke="currentColor"
							viewBox="0 0 24 24"
							xmlns="http://www.w3.org/2000/svg">
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								stroke-width="2"
								d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
						</svg>
					</div>
					<h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Pranešimas</h3>
					<div class="mt-2 px-7 py-3">
						<p class="text-sm text-gray-500" id="modal-message"></p>
					</div>
					<div class="items-center px-4 py-3" id="modal-buttons"></div>
				</div>
			</div>
		</div>

		<script>
			document.addEventListener('DOMContentLoaded', function () {
				const modal = document.getElementById('custom-modal');
				const modalTitle = document.getElementById('modal-title');
				const modalMessage = document.getElementById('modal-message');
				const modalButtons = document.getElementById('modal-buttons');

				function hideModal() {
					modal.classList.add('hidden');
				}

				function showModal(title, message, buttons) {
					modalTitle.textContent = title;
					modalMessage.textContent = message;
					modalButtons.innerHTML = '';
					const buttonContainer = document.createElement('div');
					buttonContainer.className = 'flex justify-center space-x-4';

					buttons.forEach(btnConfig => {
						const button = document.createElement('button');
						button.textContent = btnConfig.text;
						button.className = btnConfig.classes;
						button.addEventListener('click', () => {
							hideModal();
							if (btnConfig.onClick) {
								btnConfig.onClick();
							}
						});
						buttonContainer.appendChild(button);
					});

					modalButtons.appendChild(buttonContainer);
					modal.classList.remove('hidden');
				}

				function customAlert(message, title = 'Pranešimas') {
					showModal(title, message, [
						{
							text: 'Gerai',
							classes:
								'px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-lg w-24 shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500',
							onClick: () => {},
						},
					]);
				}

				function customConfirm(message, callback, title = 'Patvirtinimas') {
					showModal(title, message, [
						{
							text: 'Atšaukti',
							classes:
								'px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-lg w-24 shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400',
							onClick: () => callback(false),
						},
						{
							text: 'Gerai',
							classes:
								'px-4 py-2 bg-green-600 text-white text-base font-medium rounded-lg w-24 shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500',
							onClick: () => callback(true),
						},
					]);
				}

				let currentStep = 1;
				const totalSteps = 6;
				let sampleCounter = 230;
				let currentSampleNumber = null;
				let selectedScenario = null;
				let selectedScenarioText = '';

				let suppliers = [];
				const SUPPLIERS_ENDPOINT =
					'https://operations.baltijosjavai.lt/webhook/get-clients-with-data';
				const UPDATE_ENDPOINT = 'https://operations.baltijosjavai.lt/webhook/update-sample';
				const GET_SAMPLES_ENDPOINT =
					'https://operations.baltijosjavai.lt/webhook/get-samples-history';
				const ELEVATORS_ENDPOINT = 'https://operations.baltijosjavai.lt/webhook/elevators';

				const loadSuppliers = async token => {
					try {
						const url = new URL(SUPPLIERS_ENDPOINT);
						if (selectedScenario) url.searchParams.set('scenario', selectedScenario);
						const resp = await fetch(url.toString(), {
							headers: { accept: 'application/json', Authorization: token || '' },
						});
						if (!resp.ok) {
							let bodyText = '';
							try {
								bodyText = await resp.text();
							} catch {}
							throw new Error(
								`Suppliers fetch failed: HTTP ${resp.status}${bodyText ? ' - ' + bodyText : ''}`
							);
						}
						const data = await resp.json();

						const candidates = Array.isArray(data)
							? data
							: Array.isArray(data?.suppliers)
							? data.suppliers
							: Array.isArray(data?.data)
							? data.data
							: null;
						if (!Array.isArray(candidates)) throw new Error('Neteisingas duomenų formatas');

						suppliers = candidates.map(s => ({
							...s,
							Id: s.Id ?? s.id ?? s.ID ?? null,
							name: s.name ?? s.pavadinimas ?? s.title ?? '',
							priedai: s.priedai ?? s.annexes ?? s.attachments ?? [],
						}));
					} catch (err) {
						console.error('Nepavyko užkrauti tiekėjų sąrašo iš webhook:', err);
						throw err;
					}
				};
				let selectedSupplier = null;
				let selectedAnnex = null;
				let authToken = '';

				function tokenHasInvalidChars(value) {
					if (!value) return false;
					for (const ch of value) {
						const cp = ch.codePointAt(0);
						if (cp > 255) return true;
					}
					return false;
				}

				let elevators = [];
				let selectedElevator = null;
				async function loadElevators(token) {
					const headers = { accept: 'application/json' };
					if (token) headers['Authorization'] = token;
					const url = new URL(ELEVATORS_ENDPOINT);
					if (selectedScenario) url.searchParams.set('scenario', selectedScenario);
					const resp = await fetch(url.toString(), { headers });
					if (!resp.ok) throw new Error('HTTP ' + resp.status);
					const data = await resp.json();

					let list = null;
					if (Array.isArray(data) && data.length && Array.isArray(data[0]?.elevators)) {
						list = data[0].elevators;
					} else if (data && Array.isArray(data.elevators)) {
						list = data.elevators;
					} else if (Array.isArray(data)) {
						list = data;
					}
					if (!Array.isArray(list)) throw new Error('Neteisingas elevatorių formatas');
					elevators = list.map(e => ({
						...e,
						Id: e.Id ?? e.id ?? e.ID ?? null,
						pavadinimas: e.pavadinimas ?? e.name ?? '',
						kodas: e.kodas ?? e.code ?? '',
					}));
				}

				const steps = document.querySelectorAll('.step-card');
				const progressBar = document.getElementById('progressBar');
				const nextButtons = document.querySelectorAll('.btn-next');
				const backButtons = document.querySelectorAll('.btn-back');
				const step1NextBtn = document.getElementById('btn-step1-next');
				const step1Loading = document.getElementById('step1-loading');
				const tokenInput = document.getElementById('auth-token');
				const step2NextBtn = document.getElementById('btn-step2-next');
				const scenarioRadios = document.querySelectorAll('input[name="scenario"]');
				const supplierInput = document.getElementById('supplier');
				const supplierAddressDiv = document.getElementById('supplier-address');
				const supplierLabel = document.querySelector('label[for="supplier"]');
				const autocompleteList = document.getElementById('autocomplete-list');
				const annexContainer = document.getElementById('annex-container');
				const annexSearchInput = document.getElementById('annex-search');
				const annexDropdown = document.getElementById('annex-dropdown');
				const annexDetailsDiv = document.getElementById('annex-details');
				const pickupDateInput = document.getElementById('pickup-date');
				const generateLabelsBtn = document.getElementById('generate-labels-btn');
				const omnivaStickerPreview = document.getElementById('omniva-sticker-preview');
				const quantityInput = document.getElementById('quantity-input');
				const generationSuccessMsg = document.getElementById('generation-success-msg');
				const step4NextBtn = document.querySelector('#step-4 .btn-next');
				const step5SendBtn = document.querySelector('#step-5 .btn-next');
				let omnivaGenerated = false;
				let generationMsgTimeout = null;
				let attachmentsReadyAt = 0;
				let attachmentsCooldownTimer = null;

				const mainProcessContainer = document.getElementById('main-process-container');
				const registerView = document.getElementById('register-view');
				const openRegisterBtn = document.getElementById('btn-open-register');
				const backToMainBtn = document.getElementById('btn-back-to-main');
				const openRegisterSuccessBtn = document.getElementById('btn-open-register-success');
				const goStartBtn = document.getElementById('btn-go-start');

				const registerAnnexFilterInput = document.getElementById('register-annex-filter');
				const thPaemimo = document.getElementById('th-paemimo-data');
				const thMeginio = document.getElementById('th-meginio-nr');
				const sortIndPaemimo = document.getElementById('sort-ind-paemimo');
				const sortIndMeginio = document.getElementById('sort-ind-meginio');

				let registerRowsOriginal = [];
				let registerSortKey = null;
				let registerSortDir = 'asc';
				let registerAnnexFilter = '';

				function parseDateSafe(value) {
					if (!value) return NaN;
					const t = Date.parse(value);
					return isNaN(t) ? NaN : t;
				}

				function compareValues(a, b, key) {
					const va = a && a[key];
					const vb = b && b[key];
					if (key === 'paemimo_data') {
						const da = parseDateSafe(va);
						const db = parseDateSafe(vb);
						if (!isNaN(da) && !isNaN(db)) return da - db;
					}
					const sa = (va ?? '').toString().toLowerCase();
					const sb = (vb ?? '').toString().toLowerCase();
					if (sa < sb) return -1;
					if (sa > sb) return 1;
					return 0;
				}

				function setSortIndicators() {
					if (sortIndPaemimo)
						sortIndPaemimo.textContent =
							registerSortKey === 'paemimo_data' ? (registerSortDir === 'asc' ? '↑' : '↓') : '↕';
					if (sortIndMeginio)
						sortIndMeginio.textContent =
							registerSortKey === 'kodas' ? (registerSortDir === 'asc' ? '↑' : '↓') : '↕';
				}

				function renderRegisterTable(tbodyElement) {
					if (!tbodyElement) return;
					let rows = Array.isArray(registerRowsOriginal) ? [...registerRowsOriginal] : [];

					if (registerAnnexFilter) {
						const q = registerAnnexFilter.toLowerCase();
						rows = rows.filter(r => ((r && r.priedo_pavadinimas) || '').toLowerCase().includes(q));
					}

					if (registerSortKey) {
						rows.sort((a, b) => compareValues(a, b, registerSortKey));
						if (registerSortDir === 'desc') rows.reverse();
					}

					tbodyElement.innerHTML = '';
					if (rows.length === 0) {
						tbodyElement.innerHTML =
							'<tr><td colspan="8" class="text-center p-4">Duomenų nerasta.</td></tr>';
						return;
					}

					rows.forEach(r => {
						const vadybininkas = (r && r.vadybininkas) || 'N/A';
						const paemimo_data = (r && r.paemimo_data) || 'N/A';
						const kodas = (r && r.kodas) || 'N/A';
						const tiekejas = (r && r.klientas && r.klientas.pavadinimas) || 'N/A';
						const paemimo_vieta = (r && r.sandelys) || 'N/A';
						const siunciama_i = (r && r.pristatymo_vieta) || 'N/A';
						const sutarties_priedas = (r && r.priedo_pavadinimas) || 'N/A';
						const tr = document.createElement('tr');
						tr.innerHTML = `
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${vadybininkas}</td>
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${paemimo_data}</td>
							<td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">${kodas}</td>
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${tiekejas}</td>
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${paemimo_vieta}</td>
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${siunciama_i}</td>
							<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${sutarties_priedas}</td>
							<td class="px-6 py-4 whitespace-nowrap text-sm"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Išsiųsta</span></td>
						`;
						tbodyElement.appendChild(tr);
					});

					setSortIndicators();
				}

				const elevatorContainer = document.getElementById('elevator-container');
				const elevatorSelect = document.getElementById('elevator-select');
				const elevatorAddressDiv = document.getElementById('elevator-address');

				function populateElevatorDropdown() {
					elevatorSelect.innerHTML =
						'<option value="" disabled selected>Pasirinkite elevatorių...</option>';
					(elevators || []).forEach(elevator => {
						const option = document.createElement('option');
						option.value = elevator.Id;
						const code = elevator.kodas || '';
						option.textContent = `${code ? code + ' - ' : ''}${elevator.pavadinimas || ''}`;
						elevatorSelect.appendChild(option);
					});
				}
				populateElevatorDropdown();

				function showGenerationSuccessOnce() {
					if (generationMsgTimeout) {
						clearTimeout(generationMsgTimeout);
						generationMsgTimeout = null;
					}
					generationSuccessMsg.classList.remove('hidden');
					generationMsgTimeout = setTimeout(() => {
						generationSuccessMsg.classList.add('hidden');
						generationMsgTimeout = null;
					}, 3000);
				}

				function setAttachmentButtonsEnabled(enabled) {
					const sampleBtn = document.getElementById('download-sample-sticker');
					const postBtn = document.getElementById('download-post-sticker');
					[sampleBtn, postBtn].forEach(btn => {
						if (!btn) return;
						btn.disabled = !enabled;
						if (enabled) {
							btn.classList.remove('opacity-50', 'cursor-not-allowed');
							btn.classList.add('cursor-pointer');
						} else {
							btn.classList.add('opacity-50', 'cursor-not-allowed');
							btn.classList.remove('cursor-pointer');
						}
					});
				}

				function startAttachmentsCooldown(seconds = 10) {
					const msg = document.getElementById('attachments-cooldown-msg');
					const secs = document.getElementById('attachments-cooldown-seconds');
					attachmentsReadyAt = Date.now() + seconds * 1000;
					if (msg) msg.classList.remove('hidden');
					setAttachmentButtonsEnabled(false);
					if (step5SendBtn) step5SendBtn.disabled = true;
					if (step5SendBtn) {
						step5SendBtn.classList.add('disabled:cursor-not-allowed');
					}
					if (secs) secs.textContent = String(seconds);
					if (attachmentsCooldownTimer) {
						clearInterval(attachmentsCooldownTimer);
						attachmentsCooldownTimer = null;
					}
					attachmentsCooldownTimer = setInterval(() => {
						const remainMs = attachmentsReadyAt - Date.now();
						const remain = Math.max(0, Math.ceil(remainMs / 1000));
						if (secs) secs.textContent = String(remain);
						if (remain <= 0) {
							clearInterval(attachmentsCooldownTimer);
							attachmentsCooldownTimer = null;
							if (msg) msg.classList.add('hidden');
							setAttachmentButtonsEnabled(true);
							if (step5SendBtn && omnivaGenerated) step5SendBtn.disabled = false;
							if (step5SendBtn) step5SendBtn.classList.remove('disabled:cursor-not-allowed');
						}
					}, 200);
				}

				function attachmentsAvailable() {
					return Date.now() >= attachmentsReadyAt;
				}

				// --- Download helpers for attachments in Step 5 ---
				async function downloadWithAuth(url, filename) {
					try {
						const headers = { accept: 'application/pdf', 'content-type': 'application/json' };
						if (authToken) headers['Authorization'] = authToken;
						const clientId = selectedSupplier
							? selectedSupplier.Id ?? selectedSupplier.id ?? null
							: null;
						if (!clientId) {
							customAlert('Nepasirinktas klientas – negalima atsisiųsti failo.');
							return;
						}
						if (!attachmentsAvailable()) {
							const remain = Math.max(0, Math.ceil((attachmentsReadyAt - Date.now()) / 1000));
							customAlert('Failai dar ruošiami. Bandykite po ' + remain + ' s.');
							return;
						}
						const resp = await fetch(url, {
							method: 'POST',
							headers,
							body: JSON.stringify({ clientId, scenario: selectedScenario || null }),
						});
						if (!resp.ok) throw new Error('HTTP ' + resp.status);
						const blob = await resp.blob();
						const a = document.createElement('a');
						const objectUrl = URL.createObjectURL(blob);
						a.href = objectUrl;
						a.download = filename;
						document.body.appendChild(a);
						a.click();
						a.remove();
						URL.revokeObjectURL(objectUrl);
					} catch (e) {
						console.error('Download failed:', e);
						customAlert('Nepavyko atsisiųsti failo. Patikrinkite ryšį ir bandykite dar kartą.');
					}
				}
				const sampleStickerBtn = document.getElementById('download-sample-sticker');
				if (sampleStickerBtn) {
					sampleStickerBtn.addEventListener('click', () => {
						downloadWithAuth(
							'https://operations.baltijosjavai.lt/webhook/download-sample-sticker',
							'meginio_lipdukas.pdf'
						);
					});
				}
				const postStickerBtn = document.getElementById('download-post-sticker');
				if (postStickerBtn) {
					postStickerBtn.addEventListener('click', () => {
						downloadWithAuth(
							'https://operations.baltijosjavai.lt/webhook/download-post-sticker',
							'siuntos_lipdukas.pdf'
						);
					});
				}

				const updateProgressBar = () => {
					const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
					progressBar.style.width = `${progress}%`;
				};

				function updatePickupDetails(scenario) {
					const pickup = { name: '', address: '' };
					const nameEl = document.getElementById('pickup-display-name');
					const addressEl = document.getElementById('pickup-display-address');

					if (!nameEl || !addressEl) return;

					if (scenario === 'farm-vm') {
						if (selectedSupplier) {
							pickup.name = selectedSupplier.name || 'Nenurodytas ūkis';
							let addr = '';
							if (selectedSupplier.address && typeof selectedSupplier.address === 'object') {
								const a = selectedSupplier.address;
								const parts = [
									a.street,
									a.building || a.building_number,
									a.city,
									a.postal_code,
								].filter(Boolean);
								addr = parts.join(', ');
							}
							pickup.address = addr;
						}
					} else if (['elevator-vm', 'elevator-biliunai', 'elevator-office'].includes(scenario)) {
						if (selectedElevator) {
							pickup.name = selectedElevator.pavadinimas || 'Nenurodytas elevatorius';
							let addr = '';
							const parts = [
								selectedElevator.gatve,
								selectedElevator.pastato_nr,
								selectedElevator.miestas,
								selectedElevator.pasto_kodas,
							].filter(Boolean);
							addr = parts.join(', ');
							pickup.address = addr;
						}
					}

					nameEl.textContent = pickup.name;
					addressEl.innerHTML = `<span class="font-semibold text-red-600">Adresas:</span> ${
						pickup.address || ''
					}`;
				}

				function updateRecipientDetails(scenario) {
					const recipient = { name: '', contact: '', address: '', phone: '' };

					switch (scenario) {
						case 'farm-vm':
						case 'elevator-vm':
							recipient.name = 'UAB Viking Malt';
							recipient.contact = 'Dovydas';
							recipient.address = 'Panevėžio m. Pramonės g. 2, LT-35289, Panevėžys';
							recipient.phone = '+370 691 51153';
							break;
						case 'elevator-biliunai':
							recipient.name = 'UAB "Biliūnų grūdai"';
							recipient.contact = 'Priėmimo skyrius';
							recipient.address = 'Biliūnai, Raseinių r. sav., LT-60200';
							recipient.phone = '+370 612 34567';
							break;
						case 'elevator-office':
							recipient.name = 'UAB "Baltijos javai" (Ofisas)';
							recipient.contact = 'Renata Bernotienė';
							recipient.address = 'Svirbygalos g. 19, Kaunas, LT-46280';
							recipient.phone = '+370 699 99999';
							break;
					}

					const stickerNameEl = document.getElementById('recipient-name');
					const stickerContactEl = document.getElementById('recipient-contact');
					const stickerAddressEl = document.getElementById('recipient-address-line1');
					const stickerPhoneEl = document.getElementById('recipient-phone');

					if (stickerNameEl) stickerNameEl.textContent = recipient.name;
					if (stickerContactEl) stickerContactEl.textContent = recipient.contact;
					if (stickerAddressEl) stickerAddressEl.textContent = recipient.address;
					if (stickerPhoneEl) stickerPhoneEl.textContent = recipient.phone;

					const displayNameEl = document.getElementById('recipient-display-name');
					const displayAddressEl = document.getElementById('recipient-display-address');
					const displayContactPersonEl = document.getElementById(
						'recipient-display-contact-person'
					);
					const displayPhoneEl = document.getElementById('recipient-display-phone');

					if (displayNameEl) displayNameEl.textContent = recipient.name;
					if (displayAddressEl) displayAddressEl.textContent = `Adresas: ${recipient.address}`;
					if (displayContactPersonEl)
						displayContactPersonEl.textContent = `Kontaktinis asmuo: ${recipient.contact}`;
					if (displayPhoneEl) displayPhoneEl.textContent = `Tel.: ${recipient.phone}`;
				}

				const showStep = stepNumber => {
					steps.forEach((step, index) => {
						step.classList.toggle('visible-step', index + 1 === stepNumber);
						step.classList.toggle('hidden-step', index + 1 !== stepNumber);
					});

					if (stepNumber === 1) {
						omnivaGenerated = false;
					}

					if (stepNumber === 4) {
						omnivaStickerPreview.classList.add('hidden');
						generationSuccessMsg.classList.add('hidden');

						updateRecipientDetails(selectedScenario);
						updatePickupDetails(selectedScenario);

						if (!pickupDateInput.value) {
							const step3DateEl = document.getElementById('step3-date');
							if (step3DateEl && step3DateEl.value) {
								pickupDateInput.value = step3DateEl.value;
							}
						}

						const omnivaDateEl = document.getElementById('omniva-date');
						if (omnivaDateEl && pickupDateInput.value) {
							omnivaDateEl.textContent = pickupDateInput.value;
						}

						const cityEl = document.getElementById('ship-city');
						const streetEl = document.getElementById('ship-street');
						const buildingEl = document.getElementById('ship-building');
						const postalEl = document.getElementById('ship-postal');

						cityEl.value = '';
						streetEl.value = '';
						buildingEl.value = '';
						postalEl.value = '';

						const isElevatorScenario = [
							'elevator-vm',
							'elevator-biliunai',
							'elevator-office',
						].includes(selectedScenario);
						if (isElevatorScenario && selectedElevator) {
							if (cityEl) cityEl.value = selectedElevator.miestas || '';
							if (streetEl) streetEl.value = selectedElevator.gatve || '';
							if (buildingEl) buildingEl.value = selectedElevator.pastato_nr || '';
							if (postalEl) postalEl.value = selectedElevator.pasto_kodas || '';
						}

						if (isElevatorScenario && !selectedElevator && elevatorSelect) {
							const val = elevatorSelect.value;
							if (val) {
								selectedElevator =
									(elevators || []).find(
										e => String(e.id ?? e.Id ?? e.ID ?? e.kodas ?? '').trim() === String(val).trim()
									) || null;
							}
						}

						if (omnivaGenerated) {
							if (generateLabelsBtn) generateLabelsBtn.classList.add('hidden');
						} else {
							if (generateLabelsBtn) generateLabelsBtn.classList.remove('hidden');
						}

						if (step4NextBtn) step4NextBtn.disabled = !omnivaGenerated;
					}

					if (stepNumber === 5) {
						const step5 = document.getElementById('step-5');
						if (!omnivaGenerated) {
							if (step5) step5.classList.add('opacity-50');
							if (step5SendBtn) step5SendBtn.disabled = true;
						} else {
							if (step5) step5.classList.remove('opacity-50');
							if (step5SendBtn) step5SendBtn.disabled = false;
						}
						startAttachmentsCooldown(10);
						if (step5SendBtn && !attachmentsAvailable()) step5SendBtn.disabled = true;
					}

					currentStep = stepNumber;
					updateProgressBar();
				};

				const updateUIData = () => {
					if (!selectedSupplier || !selectedAnnex) return;

					if (currentStep === 2) {
						currentSampleNumber = 'BJ25 M' + sampleCounter++;
						const selectedAnnexData = (
							selectedSupplier.priedai ||
							selectedSupplier.annexes ||
							[]
						).find(a => a.nr === selectedAnnex);
						const initialQuantity = selectedAnnexData ? selectedAnnexData.quantity : 'N/A';
						quantityInput.value = initialQuantity;
						document
							.querySelectorAll('.label-quantity')
							.forEach(el => (el.textContent = initialQuantity));

						const today = new Date();
						const deliveryDate = new Date();
						deliveryDate.setDate(today.getDate() + 3);
						const formattedDateLT = deliveryDate.toLocaleDateString('lt-LT');
						const formattedDateISO = deliveryDate.toISOString().split('T')[0];

						document
							.querySelectorAll('.label-sample-nr')
							.forEach(el => (el.textContent = currentSampleNumber));
						document
							.querySelectorAll('.label-date')
							.forEach(el => (el.textContent = formattedDateLT));
						const step3DateInputEl = document.getElementById('step3-date');
						if (step3DateInputEl) step3DateInputEl.value = formattedDateISO;
						if (pickupDateInput) pickupDateInput.value = formattedDateISO;

						const isElevatorScenario = [
							'elevator-vm',
							'elevator-biliunai',
							'elevator-office',
						].includes(selectedScenario);
						const location =
							isElevatorScenario && selectedElevator
								? selectedElevator.name
								: selectedSupplier.address || selectedSupplier.location || '';
						// ******** PAKEITIMO PABAIGA ********
						document.querySelectorAll('.label-location').forEach(el => (el.textContent = location));
						document
							.querySelectorAll('.label-variety')
							.forEach(
								el =>
									(el.textContent =
										(selectedAnnexData &&
											(selectedAnnexData.veisle || selectedAnnexData.variety || '')) ||
										'')
							);
					}
				};

				const validateStep2 = () => {
					let isValid = false;
					const isElevatorScenario = [
						'elevator-vm',
						'elevator-biliunai',
						'elevator-office',
					].includes(selectedScenario);
					if (isElevatorScenario) {
						isValid = !!(selectedAnnex && (selectedElevator || selectedSupplier));
					} else {
						isValid = !!(
							selectedSupplier &&
							selectedAnnex &&
							supplierInput.value.trim().toLowerCase() ===
								selectedSupplier.name.trim().toLowerCase()
						);
					}
					step2NextBtn.disabled = !isValid;
				};

				const resetAnnex = () => {
					annexContainer.classList.add('hidden');
					annexDetailsDiv.classList.add('hidden');
					annexSearchInput.value = '';
					selectedAnnex = null;
					validateStep2();
				};

				const validateStep1 = () => {
					const scenarioChosen = !!document.querySelector('input[name="scenario"]:checked');
					const tokenVal = tokenInput ? tokenInput.value.trim() : '';
					const tokenPresent = !!tokenVal;
					const tokenInvalid = tokenHasInvalidChars(tokenVal);
					if (tokenInput) {
						tokenInput.classList.toggle('border-red-500', tokenInvalid);
					}
					// Pataisymas: mygtukas aktyvuojamas tik jei nėra negaliojančių simbolių
					step1NextBtn.disabled = !(scenarioChosen && tokenPresent && !tokenInvalid);
				};

				function renderHistoryTable(tbodyElement, rows) {}

				nextButtons.forEach(button => {
					button.addEventListener('click', () => {
						if (currentStep < totalSteps) {
							if (currentStep === 2) {
								updateUIData();
							} else if (currentStep === 4) {
								if (!omnivaGenerated) {
									customAlert('Pirma sugeneruokite siuntos etiketę.');
									return;
								}
								const emailToInput = document.getElementById('email-to-input');
								const emailSubjectInput = document.getElementById('email-subject-input');
								const emailBodyInput = document.getElementById('email-body-input');

								emailToInput.value = selectedSupplier.email;
								emailSubjectInput.value = `Mėginio paėmimas pagal sutartį ${selectedAnnex}`;

								let formattedDateLT;
								if (pickupDateInput.value) {
									const dateObj = new Date(pickupDateInput.value);
									const userTimezoneOffset = dateObj.getTimezoneOffset() * 60000;
									const adjustedDate = new Date(dateObj.getTime() + userTimezoneOffset);
									formattedDateLT = adjustedDate.toLocaleDateString('lt-LT');
								} else {
									const deliveryDate = new Date();
									deliveryDate.setDate(new Date().getDate() + 3);
									formattedDateLT = deliveryDate.toLocaleDateString('lt-LT');
								}
								const shipStreet = (document.getElementById('ship-street') || {}).value || '';
								const shipBuilding = (document.getElementById('ship-building') || {}).value || '';
								const shipCity = (document.getElementById('ship-city') || {}).value || '';
								const shipPostal = (document.getElementById('ship-postal') || {}).value || '';
								const addressLine =
									`${shipStreet} ${shipBuilding}, ${shipCity}, ${shipPostal}`.trim();

								const bodyText = `Sveiki,

Kurjeris atvyks ${formattedDateLT} | 12:00-13:30 | ${addressLine}.

Primename, kad adreso kortelės lipdukas klijuojamas ant siuntos kurjeriui.

Svarbu: Lipdukas mėginiui yra klijuojamas ant miežių mėginio pavyzdžio (2 kg). Jeigu mėginys bus be lipduko, kuris yra sukurtas jus identifikuoti, tyrimas laboratorijoje nebus atliekamas.

Pagarbiai/Kind regards,
Renata Bernotienė
Logistikos administratorė
UAB "Baltijos javai"`;

								emailBodyInput.value = bodyText;
							} else if (currentStep === 5) {
								const emailToInput = document.getElementById('email-to-input');
								const emailSubjectInput = document.getElementById('email-subject-input');
								const emailBodyInput = document.getElementById('email-body-input');
								const sendBtn = document.querySelector('#step-5 .btn-next');
								const sendingIndicator = document.getElementById('step5-sending');
								if (!attachmentsAvailable()) {
									const remain = Math.max(0, Math.ceil((attachmentsReadyAt - Date.now()) / 1000));
									customAlert('Failai ruošiami. Siuntimas galimas po ' + remain + ' s.');
									return;
								}
								if (!emailToInput.value || !emailToInput.value.trim()) {
									customAlert('Laukas "Kam" yra privalomas.');
									emailToInput.focus();
									return;
								}
								const clientId = selectedSupplier
									? selectedSupplier.Id ?? selectedSupplier.id ?? null
									: null;
								const payload = {
									to: emailToInput.value.trim(),
									subject: emailSubjectInput.value || '',
									body: emailBodyInput.value || '',
									clientId,
									sampleNumber: currentSampleNumber,
									annex: selectedAnnex || null,
									pickupDate: pickupDateInput.value || null,
									scenario: selectedScenario || null,
									vadybininkas: (function () {
										const list = selectedSupplier
											? selectedSupplier.priedai || selectedSupplier.annexes || []
											: [];
										const a = list.find(x => x && x.nr === selectedAnnex);
										return (
											(a && (a.vadybininkas || a.manager)) ||
											(selectedSupplier &&
												(selectedSupplier.vadybininkas || selectedSupplier.manager)) ||
											''
										);
									})(),
								};

								const headers = { accept: 'application/json', 'content-type': 'application/json' };
								if (authToken) headers['Authorization'] = authToken;
								if (sendBtn) sendBtn.disabled = true;
								if (sendingIndicator) sendingIndicator.classList.remove('hidden');
								fetch('https://operations.baltijosjavai.lt/webhook/send-email', {
									method: 'POST',
									headers,
									body: JSON.stringify(payload),
								})
									.then(resp => {
										if (!resp.ok) throw new Error('HTTP ' + resp.status);
										return resp.json().catch(() => ({}));
									})
									.then(data => {
										const rows = Array.isArray(data?.samples)
											? data.samples
											: Array.isArray(data)
											? data
											: [];
										const tbody = document.getElementById('history-table-body');
										renderHistoryTable(tbody, rows);
										showStep(currentStep + 1);
									})
									.catch(err => {
										console.error('Siuntimo klaida:', err);
										customAlert('Nepavyko išsiųsti el. laiško. Bandykite dar kartą.');
									})
									.finally(() => {
										if (sendBtn) sendBtn.disabled = false;
										if (sendingIndicator) sendingIndicator.classList.add('hidden');
									});
								return;
							}
							showStep(currentStep + 1);
						}
					});
				});

				backButtons.forEach(button => {
					button.addEventListener('click', () => {
						if (currentStep > 1) showStep(currentStep - 1);
					});
				});

				scenarioRadios.forEach(radio => {
					radio.addEventListener('change', () => {
						validateStep1();
						const checkedRadio = document.querySelector('input[name="scenario"]:checked');
						selectedScenario = checkedRadio.value;
						selectedScenarioText = checkedRadio.nextElementSibling.textContent.trim();
					});
				});
				if (tokenInput) {
					tokenInput.addEventListener('input', () => {
						authToken = tokenInput.value.trim();
						validateStep1();
					});
				}

				step1NextBtn.addEventListener('click', async () => {
					const tokenVal = tokenInput ? tokenInput.value.trim() : '';
					if (tokenHasInvalidChars(tokenVal)) {
						customAlert('Rakte negalima lietuviškų raidžių!');
						return;
					}
					step1NextBtn.disabled = true;
					if (step1Loading) step1Loading.classList.remove('hidden');
					try {
						document.querySelectorAll('.scenario-display-text').forEach(el => {
							el.textContent = selectedScenarioText;
						});
						const isElevatorScenario = [
							'elevator-vm',
							'elevator-biliunai',
							'elevator-office',
						].includes(selectedScenario);
						if (isElevatorScenario) {
							try {
								await loadElevators(authToken);
								populateElevatorDropdown();
								elevatorContainer.classList.remove('hidden');
								supplierLabel.textContent = 'Iš kur atvežta (Tiekėjas)';
							} catch (e) {
								console.error('Nepavyko užkrauti elevatorių:', e);
								customAlert('Nepavyko užkrauti elevatorių sąrašo.');
								return;
							}
							await loadSuppliers(authToken);
						} else {
							await loadSuppliers(authToken);
							elevatorContainer.classList.add('hidden');
							supplierLabel.textContent = 'Iš kur siunčiama (Tiekėjas)';
						}

						validateStep2();
						showStep(2);
					} catch (e) {
						console.error('Step 1→2 data load failed:', e);
						const msg =
							(e && e.message) ||
							'Nepavyko užkrauti duomenų. Patikrinkite prieigos žetoną ir bandykite dar kartą.';
						customAlert(msg);
					} finally {
						validateStep1();
						if (step1Loading) step1Loading.classList.add('hidden');
					}
				});

				document.getElementById('btn-restart').addEventListener('click', () => {
					selectedSupplier = null;
					selectedElevator = null;
					elevatorSelect.value = '';
					elevatorContainer.classList.add('hidden');
					elevatorAddressDiv.classList.add('hidden');
					supplierLabel.textContent = 'Iš kur siunčiama (Tiekėjas)';

					currentSampleNumber = null;
					supplierInput.value = '';
					supplierAddressDiv.classList.add('hidden');
					autocompleteList.classList.add('hidden');
					resetAnnex();
					scenarioRadios.forEach(r => (r.checked = false));
					step1NextBtn.disabled = true;
					selectedScenario = null;
					selectedScenarioText = '';
					document.querySelectorAll('.scenario-display-text').forEach(el => {
						el.textContent = '';
					});
					omnivaStickerPreview.classList.add('hidden');
					pickupDateInput.value = '';
					quantityInput.value = '';
					generationSuccessMsg.classList.add('hidden');
					omnivaGenerated = false;
					if (step4NextBtn) step4NextBtn.disabled = true;
					if (generateLabelsBtn) generateLabelsBtn.classList.remove('hidden');
					const msg = document.getElementById('attachments-cooldown-msg');
					if (attachmentsCooldownTimer) clearInterval(attachmentsCooldownTimer);
					attachmentsCooldownTimer = null;
					attachmentsReadyAt = 0;
					if (msg) msg.classList.add('hidden');
					setAttachmentButtonsEnabled(true);
					if (step5SendBtn) step5SendBtn.disabled = true;
					showStep(1);
				});

				quantityInput.addEventListener('input', () => {
					const quantityValue = quantityInput.value.trim() ? quantityInput.value : '0t';
					document
						.querySelectorAll('.label-quantity')
						.forEach(el => (el.textContent = quantityValue));
				});

				const step3DateInput = document.getElementById('step3-date');
				if (step3DateInput) {
					step3DateInput.addEventListener('change', () => {
						const val = step3DateInput.value;
						if (!val) return;
						const d = new Date(val);
						const adjusted = new Date(d.getTime() + d.getTimezoneOffset() * 60000);
						const formattedDateLT = adjusted.toLocaleDateString('lt-LT');
						document
							.querySelectorAll('.label-date')
							.forEach(el => (el.textContent = formattedDateLT));
						if (pickupDateInput) pickupDateInput.value = val;
						const omnivaDateEl = document.getElementById('omniva-date');
						if (omnivaDateEl) omnivaDateEl.textContent = val;
					});
				}
				if (pickupDateInput) {
					pickupDateInput.addEventListener('change', () => {
						const val = pickupDateInput.value;
						if (!val) return;
						const d = new Date(val);
						const adjusted = new Date(d.getTime() + d.getTimezoneOffset() * 60000);
						const formattedDateLT = adjusted.toLocaleDateString('lt-LT');
						document
							.querySelectorAll('.label-date')
							.forEach(el => (el.textContent = formattedDateLT));
						const step3DateEl = document.getElementById('step3-date');
						if (step3DateEl) step3DateEl.value = val;
						const omnivaDateEl = document.getElementById('omniva-date');
						if (omnivaDateEl) omnivaDateEl.textContent = val;
					});
				}

				generateLabelsBtn.addEventListener('click', () => {
					const cityEl = document.getElementById('ship-city');
					const streetEl = document.getElementById('ship-street');
					const buildingEl = document.getElementById('ship-building');
					const postalEl = document.getElementById('ship-postal');
					const requiredMap = [
						{ el: cityEl, label: 'Miestas' },
						{ el: streetEl, label: 'Gatvė' },
						// { el: buildingEl, label: 'Pastato nr.' }, // Pastato nr. gali būti nebūtinas
						{ el: postalEl, label: 'Pašto kodas' },
					];
					const missing = requiredMap.filter(({ el }) => !el || !el.value || !el.value.trim());
					if (missing.length > 0) {
						customAlert(
							'Užpildykite visus privalomus adreso laukus: ' + missing.map(m => m.label).join(', ')
						);
						if (missing[0] && missing[0].el) missing[0].el.focus();
						return;
					}

					const selectedDate = pickupDateInput.value;
					if (!selectedDate) {
						customAlert('Nurodykite paėmimo datą.');
						pickupDateInput.focus();
						return;
					}

					customConfirm('Ar tikrai norite generuoti siuntos etiketę?', confirmed => {
						if (!confirmed) {
							return;
						}

						generateLabelsBtn.classList.add('hidden');

						const dateObj = new Date(selectedDate);
						const userTimezoneOffset = dateObj.getTimezoneOffset() * 60000;
						const adjustedDate = new Date(dateObj.getTime() + userTimezoneOffset);

						const formattedDateLT = adjustedDate.toLocaleDateString('lt-LT');
						const formattedDateISO = adjustedDate.toISOString().split('T')[0];

						document
							.querySelectorAll('.label-date')
							.forEach(el => (el.textContent = formattedDateLT));
						document.getElementById('omniva-date').textContent = formattedDateISO;
						const step3DateEl = document.getElementById('step3-date');
						if (step3DateEl) step3DateEl.value = formattedDateISO;

						const resolveSelectedAnnex = () => {
							if (!selectedSupplier) return null;
							const list = selectedSupplier.priedai || selectedSupplier.annexes || [];
							return list.find(a => a.nr === selectedAnnex) || null;
						};
						const selectedAnnexObj = resolveSelectedAnnex();
						const shipCity = (document.getElementById('ship-city') || {}).value || '';
						const shipStreet = (document.getElementById('ship-street') || {}).value || '';
						const shipBuilding = (document.getElementById('ship-building') || {}).value || '';
						const shipPostal = (document.getElementById('ship-postal') || {}).value || '';

						// ******** PAKEITIMAS ČIA ********
						const isElevatorScenario = [
							'elevator-vm',
							'elevator-biliunai',
							'elevator-office',
						].includes(selectedScenario);
						const payload = {
							sampleNumber: currentSampleNumber,
							pickupDate: formattedDateISO,
							supplierId: selectedSupplier
								? selectedSupplier.Id ?? selectedSupplier.id ?? null
								: null,
							annexId: selectedAnnexObj ? selectedAnnexObj.Id ?? selectedAnnexObj.id ?? null : null,
							supplier: selectedSupplier
								? {
										name: selectedSupplier.name,
										address: selectedSupplier.address || '',
										email: selectedSupplier.email || '',
										location: selectedSupplier.location || '',
								  }
								: null,
							annex: selectedAnnex || null,
							quantity: quantityInput && quantityInput.value ? quantityInput.value : '',
							variety: selectedAnnexObj
								? selectedAnnexObj.veisle || selectedAnnexObj.variety || ''
								: '',
							vadybininkas: (function () {
								const list = selectedSupplier
									? selectedSupplier.priedai || selectedSupplier.annexes || []
									: [];
								const a = list.find(x => x && x.nr === selectedAnnex);
								return (
									(a && (a.vadybininkas || a.manager)) ||
									(selectedSupplier &&
										(selectedSupplier.vadybininkas || selectedSupplier.manager)) ||
									''
								);
							})(),
							pristatymas_nuo: selectedAnnexObj ? selectedAnnexObj.pristatymas_nuo || '' : '',
							pristatymas_iki: selectedAnnexObj ? selectedAnnexObj.pristatymas_iki || '' : '',
							pickupAddress: {
								city: shipCity,
								street: shipStreet,
								building_number: shipBuilding,
								postal_code: shipPostal,
							},
							scenario: selectedScenario,
							elevatorId:
								isElevatorScenario && selectedElevator
									? selectedElevator.Id ||
									  selectedElevator.id ||
									  selectedElevator.elevator_id ||
									  null
									: null,
							elevator:
								isElevatorScenario && selectedElevator
									? {
											id:
												selectedElevator.Id ||
												selectedElevator.id ||
												selectedElevator.elevator_id ||
												null,
											kodas: selectedElevator.kodas || '',
											pavadinimas: selectedElevator.pavadinimas || '',
											address: {
												street: selectedElevator.gatve || '',
												building_number: selectedElevator.pastato_nr || '',
												city: selectedElevator.miestas || '',
												postal_code: selectedElevator.pasto_kodas || '',
											},
									  }
									: null,
						};

						const headers = { accept: 'application/json', 'content-type': 'application/json' };
						if (authToken) headers['Authorization'] = authToken;

						fetch(UPDATE_ENDPOINT, {
							method: 'POST',
							headers,
							body: JSON.stringify(payload),
						})
							.then(resp => {
								if (!resp.ok) throw new Error('HTTP ' + resp.status);
								return resp.json().catch(() => ({}));
							})
							.then(() => {})
							.catch(err => {
								console.error('Nepavyko atnaujinti mėginio per webhook:', err);
								customAlert(
									'Nepavyko atnaujinti mėginio. Patikrinkite prieigos žetoną ir bandykite dar kartą.'
								);
							});

						omnivaStickerPreview.classList.remove('hidden');
						showGenerationSuccessOnce();
						omnivaGenerated = true;
						if (step4NextBtn) step4NextBtn.disabled = false;
					});
				});

				elevatorSelect.addEventListener('change', function () {
					const raw = this.value;
					const selectedIdStr = String(raw).trim();

					selectedElevator =
						(elevators ?? []).find(
							e => String(e.id ?? e.Id ?? e.ID ?? e.kodas ?? '').trim() === selectedIdStr
						) || null;
					if (
						selectedElevator &&
						selectedElevator.address &&
						typeof selectedElevator.address === 'object'
					) {
						const a = selectedElevator.address;
						const street = a.street || '';
						const building = a.building || a.building_number || '';
						const city = a.city || '';
						const postal = a.postal_code || '';
						const parts = [];
						if (street) parts.push(street);
						if (building) parts.push(building);
						const line1 = parts.join(' ').trim();
						const line2 = [city, postal].filter(Boolean).join(', ');
						const full = [line1, line2].filter(Boolean).join(', ');
						if (full) {
							elevatorAddressDiv.innerHTML = `<strong>Adresas:</strong> ${full}`;
							elevatorAddressDiv.classList.remove('hidden');
						} else {
							elevatorAddressDiv.classList.add('hidden');
							elevatorAddressDiv.innerHTML = '';
						}
					} else {
						elevatorAddressDiv.classList.add('hidden');
						elevatorAddressDiv.innerHTML = '';
					}
					validateStep2();
				});

				supplierInput.addEventListener('input', function () {
					const val = this.value;
					closeAllLists();
					resetAnnex();
					selectedSupplier = null;
					validateStep2();

					if (!val) return false;

					autocompleteList.innerHTML = '';
					autocompleteList.classList.remove('hidden');

					suppliers.forEach(supplier => {
						if (supplier.name.toUpperCase().includes(val.toUpperCase())) {
							const item = document.createElement('div');
							item.innerHTML = `<strong>${supplier.name.substr(
								0,
								val.length
							)}</strong>${supplier.name.substr(val.length)}`;
							item.addEventListener('click', function () {
								supplierInput.value = supplier.name;
								selectedSupplier = supplier;
								let hasAddress = false;
								if (supplier && supplier.address && typeof supplier.address === 'object') {
									const a = supplier.address;
									const street = a.street || '';
									const building = a.building || a.building_number || '';
									const city = a.city || '';
									const postal = a.postal_code || '';
									const parts = [];
									if (street) parts.push(street);
									if (building) parts.push(building);
									const line1 = parts.join(' ').trim();
									const line2 = [city, postal].filter(Boolean).join(', ');
									const full = [line1, line2].filter(Boolean).join(', ');
									if (full) {
										supplierAddressDiv.innerHTML = `<strong>Adresas:</strong> ${full}`;
										supplierAddressDiv.classList.remove('hidden');
										hasAddress = true;
									}
								}
								if (!hasAddress) {
									supplierAddressDiv.classList.add('hidden');
									supplierAddressDiv.innerHTML = '';
								}
								closeAllLists();

								annexContainer.classList.remove('hidden');
								populateAnnexDropdown(supplier.priedai || supplier.annexes || []);
								validateStep2();
							});
							autocompleteList.appendChild(item);
						}
					});
				});

				function populateAnnexDropdown(annexes) {
					annexDropdown.innerHTML = '';
					annexes.forEach(annex => {
						const item = document.createElement('div');
						item.classList.add(
							'flex',
							'justify-between',
							'items-center',
							'w-full',
							'p-2',
							'text-sm',
							'cursor-pointer',
							'border-b',
							'hover:bg-gray-100'
						);
						item.innerHTML = `
                <span class="font-semibold text-red-500 w-1/4">${annex.nr}</span>
                <span class="text-gray-600 w-1/4"><strong class="font-medium">Priedo data:</strong> ${annex.date}</span>
                <span class="text-gray-600 w-1/4"><strong class="font-medium">Kiekis:</strong> ${annex.quantity}</span>
            `;
						item.addEventListener('click', function () {
							annexSearchInput.value = annex.nr;
							selectedAnnex = annex.nr;

							const selectedAnnexData = (
								selectedSupplier.priedai ||
								selectedSupplier.annexes ||
								[]
							).find(a => a.nr === selectedAnnex);
							if (selectedAnnexData) {
								annexDetailsDiv.innerHTML = `
                        <strong>Priedo data:</strong> ${selectedAnnexData.date} |
                        <strong>Kiekis:</strong> ${selectedAnnexData.quantity} `;
								annexDetailsDiv.classList.remove('hidden');
								quantityInput.value = selectedAnnexData.quantity;
								document
									.querySelectorAll('.label-quantity')
									.forEach(el => (el.textContent = selectedAnnexData.quantity));
								document
									.querySelectorAll('.label-variety')
									.forEach(
										el =>
											(el.textContent = selectedAnnexData.veisle || selectedAnnexData.variety || '')
									);
								const isElevatorScenario = [
									'elevator-vm',
									'elevator-biliunai',
									'elevator-office',
								].includes(selectedScenario);
								const location =
									isElevatorScenario && selectedElevator
										? selectedElevator.name
										: selectedSupplier.address || selectedSupplier.location || '';
								document
									.querySelectorAll('.label-location')
									.forEach(el => (el.textContent = location));
							}

							annexDropdown.classList.add('hidden');
							validateStep2();
						});
						annexDropdown.appendChild(item);
					});
				}

				annexSearchInput.addEventListener('input', function () {
					const filter = this.value.toUpperCase();
					const items = annexDropdown.getElementsByTagName('div');
					for (let i = 0; i < items.length; i++) {
						const txtValue = items[i].textContent || items[i].innerText;
						items[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
					}
				});

				annexSearchInput.addEventListener('focus', () => annexDropdown.classList.remove('hidden'));

				function closeAllLists(elmnt) {
					autocompleteList.classList.add('hidden');
					if (elmnt !== annexSearchInput) {
						annexDropdown.classList.add('hidden');
					}
				}

				document.addEventListener('click', function (e) {
					closeAllLists(e.target);
				});

				// --- Register View Logic ---
				const showRegister = async () => {
					if (!mainProcessContainer || !registerView) return;

					mainProcessContainer.classList.add('hidden');
					registerView.classList.remove('hidden');

					const tbody = document.getElementById('register-table-body');
					if (!tbody) return;

					tbody.innerHTML = '<tr><td colspan="8" class="text-center p-4">Kraunama...</td></tr>';

					if (!authToken) {
						customAlert(
							'Norėdami peržiūrėti registrą, pirmame žingsnyje įveskite galiojantį prieigos žetoną.'
						);
						tbody.innerHTML =
							'<tr><td colspan="8" class="text-center p-4">Reikalingas prieigos žetonas.</td></tr>';
						return;
					}

					try {
						const headers = { accept: 'application/json', Authorization: authToken };
						const url = new URL(GET_SAMPLES_ENDPOINT);
						if (selectedScenario) url.searchParams.set('scenario', selectedScenario);
						const resp = await fetch(url.toString(), { method: 'GET', headers });

						if (!resp.ok) {
							if (resp.status === 400) {
								tbody.innerHTML =
									'<tr><td colspan="8" class="text-center p-4">Duomenų bazėje mėginių nėra.</td></tr>';
								return;
							}

							let errorMsg = `HTTP ${resp.status}`;
							try {
								const errorJson = await resp.json();
								if (errorJson && errorJson.message) {
									errorMsg = errorJson.message;
								}
							} catch (e) {}
							throw new Error(errorMsg);
						}

						const samples = await resp.json();
						registerRowsOriginal = Array.isArray(samples?.data) ? samples.data : [];
						renderRegisterTable(tbody);
					} catch (err) {
						console.error('Klaida gaunant registrą:', err);
						tbody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-red-500">Nepavyko užkrauti registro duomenų. Klaida: ${err.message}</td></tr>`;
					}
				};

				if (openRegisterBtn) {
					openRegisterBtn.addEventListener('click', () => {
						const tokenVal = tokenInput ? tokenInput.value.trim() : '';
						if (tokenHasInvalidChars(tokenVal)) {
							customAlert('Rakte negalima lietuviškų raidžių!');
							return;
						}
						showRegister();
					});
				}

				if (backToMainBtn) {
					backToMainBtn.addEventListener('click', () => {
						if (!mainProcessContainer || !registerView) return;
						registerView.classList.add('hidden');
						mainProcessContainer.classList.remove('hidden');
					});
				}

				if (openRegisterSuccessBtn) {
					openRegisterSuccessBtn.addEventListener('click', () => {
						const tokenVal = tokenInput ? tokenInput.value.trim() : '';
						if (tokenHasInvalidChars(tokenVal)) {
							customAlert('Rakte negalima lietuviškų raidžių!');
							return;
						}
						showRegister();
					});
				}

				if (goStartBtn) {
					goStartBtn.addEventListener('click', () => {
						showStep(1);
					});
				}

				if (thPaemimo) {
					thPaemimo.addEventListener('click', () => {
						const tbody = document.getElementById('register-table-body');
						if (registerSortKey === 'paemimo_data') {
							registerSortDir = registerSortDir === 'asc' ? 'desc' : 'asc';
						} else {
							registerSortKey = 'paemimo_data';
							registerSortDir = 'asc';
						}
						renderRegisterTable(tbody);
					});
				}
				if (thMeginio) {
					thMeginio.addEventListener('click', () => {
						const tbody = document.getElementById('register-table-body');
						if (registerSortKey === 'kodas') {
							registerSortDir = registerSortDir === 'asc' ? 'desc' : 'asc';
						} else {
							registerSortKey = 'kodas';
							registerSortDir = 'asc';
						}
						renderRegisterTable(tbody);
					});
				}
				if (registerAnnexFilterInput) {
					registerAnnexFilterInput.addEventListener('input', () => {
						registerAnnexFilter = registerAnnexFilterInput.value.trim();
						const tbody = document.getElementById('register-table-body');
						renderRegisterTable(tbody);
					});
				}
			});
		</script>
	</body>
</html>

